import{r as y,j as n,F as Je,a as Xe,b as we,c as Ye,d as Ze,e as et,f as tt,g as rt,h as be}from"./vendor-DYaN873j.js";import{c as De}from"./state-vendor-CZdq9nfc.js";import{d as te,f as Z,h as st,j as I,k as Te,l as Se,q as L,w as ne,m as Ce,n as at,o as oe,p as pe,r as ke,T as Q,t as nt,v as ge,x as ot}from"./firebase-vendor-DEp0eLQq.js";import{d as W,a as u,g as A,b as J,c as ee,u as re}from"./auth-B_ilVF6c.js";import{T as je}from"./tasks-ByvsvQFB.js";const it=(o,s)=>{const e=o.data();return{id:o.id,userId:s,...e,createdAt:e.createdAt?.toDate?.()||new Date}};class ct{getGroupsCollection(s){return te(W,"users",s,"groups")}async ensureDefaultGroup(s){try{const e=Z(W,"users",s,"groups","default");return await st(e,{name:"Default",color:"#6B7280",icon:"üìã",createdAt:I(),updatedAt:I()},{merge:!0}),u("GroupService: Ensured default group exists"),"default"}catch(e){throw e}}async createGroup(s,e){try{u("GroupService: Creating group",{userId:s,groupData:e});const t={...e,createdAt:I(),updatedAt:I()};u("GroupService: Firestore data",t);const r=await Te(this.getGroupsCollection(s),t);return u("GroupService: Group created with ID",r.id),{id:r.id,error:null}}catch(t){return{id:null,error:A(t)}}}async updateGroup(s,e,t){try{const r=Z(this.getGroupsCollection(s),e),a={...t,updatedAt:I()};return await Se(r,a),{error:null}}catch(r){return{error:A(r)}}}async deleteGroup(s,e){if(e==="default")return{error:"Kh√¥ng th·ªÉ x√≥a nh√≥m m·∫∑c ƒë·ªãnh"};try{const t="default",r=L(te(W,"users",s,"tasks"),ne("groupId","==",e)),a=await Ce(r),i=at(W);a.docs.forEach(l=>{i.update(l.ref,{groupId:t,updatedAt:I()})});const c=Z(this.getGroupsCollection(s),e);return i.delete(c),await i.commit(),u("GroupService: Group deleted and tasks moved to default",{groupId:e,tasksCount:a.size}),{error:null}}catch(t){return{error:A(t)}}}subscribeToGroups(s,e){const t=L(this.getGroupsCollection(s),oe("createdAt","asc"));return pe(t,r=>{u("GroupService: Received snapshot",{size:r.size,empty:r.empty,changes:r.docChanges().length});const a=r.docs.map(i=>{const c=it(i,s);return u("GroupService: Converted group",{id:c.id,name:c.name}),c});u("GroupService: Calling callback with groups",a.length),e(a)},r=>{e([])})}}const X=new ct;class V{static instance;authStateHistory=[];static getInstance(){return V.instance||(V.instance=new V),V.instance}async logAuthState(s){const e=J.currentUser;let t=null,r=!1;try{e&&(t=await e.getIdToken(),r=!0)}catch{}const a={timestamp:Date.now(),user:e?{uid:e.uid,email:e.email,emailVerified:e.emailVerified}:null,token:t?t.substring(0,20)+"...":null,ready:r};return this.authStateHistory.push(a),u(`üîç Auth State [${s}]:`,{timestamp:new Date().toISOString()}),a}logFirestoreOperation(s,e,t){return{operation:s,userId:e,timestamp:Date.now(),error:t?{code:t.code,message:t.message}:null}}getDebugReport(){return{authHistory:this.authStateHistory,currentAuth:{user:J.currentUser?{uid:J.currentUser.uid,email:J.currentUser.email}:null,timestamp:Date.now()}}}async waitForAuthReady(s=5e3){const e=Date.now();for(;Date.now()-e<s;){const t=J.currentUser;if(t)try{return await t.getIdToken(),u("üéâ Auth is ready!",{uid:t.uid,waitTime:Date.now()-e}),!0}catch{}await new Promise(r=>setTimeout(r,100))}return!1}}const E=V.getInstance(),Ne=De((o,s)=>({groups:[],loading:!1,error:null,unsubscribe:null,isRealtimeMode:!0,setGroups:e=>o({groups:e}),setLoading:e=>o({loading:e}),setError:e=>o({error:e}),setUnsubscribe:e=>o({unsubscribe:e}),setRealtimeMode:e=>o({isRealtimeMode:e}),fetchGroups:()=>{const{unsubscribe:e,loading:t}=s();if(t)return;e&&e(),o({loading:!0,error:null});const a=re.getState().user;if(!a){o({loading:!1,error:"User not authenticated"});return}const i=async(c=3)=>{try{if(await E.logAuthState(`GroupStore-fetchGroups-attempt-${4-c}`),!await E.waitForAuthReady(2e3))throw new Error("Auth timeout - user not ready");E.logFirestoreOperation("ensureDefaultGroup-start",a.uid),await X.ensureDefaultGroup(a.uid),E.logFirestoreOperation("ensureDefaultGroup-success",a.uid),E.logFirestoreOperation("subscribeToGroups-start",a.uid);try{const p=X.subscribeToGroups(a.uid,g=>{E.logFirestoreOperation("subscribeToGroups-callback",a.uid),o({groups:g,loading:!1,error:null})});o({unsubscribe:p,isRealtimeMode:!0}),E.logFirestoreOperation("subscribeToGroups-success",a.uid)}catch(p){E.logFirestoreOperation("subscribeToGroups-fallback",a.uid,p);try{const g=te(W,"users",a.uid,"groups"),f=(await ke(g)).docs.map(b=>{const C=b.data();return{id:b.id,userId:a.uid,name:C.name,color:C.color,icon:C.icon,createdAt:C.createdAt?.toDate?.()||new Date}});o({groups:f,loading:!1,error:null,isRealtimeMode:!1}),E.logFirestoreOperation("getGroups-fallback-success",a.uid)}catch(g){E.logFirestoreOperation("getGroups-fallback-error",a.uid,g),o({loading:!1,error:"Failed to load groups",isRealtimeMode:!1})}}}catch(l){if(E.logFirestoreOperation("fetchGroups-error",a.uid,l),l.code==="permission-denied"&&c>0){setTimeout(()=>i(c-1),1e3);return}o({loading:!1,error:"Failed to load groups. Please try refreshing the page."})}};i()},refreshGroups:()=>{const t=re.getState().user;if(!t)return;o({loading:!0}),(async()=>{try{const a=te(W,"users",t.uid,"groups"),c=(await ke(a)).docs.map(l=>{const p=l.data();return{id:l.id,userId:t.uid,name:p.name,color:p.color,icon:p.icon,createdAt:p.createdAt?.toDate?.()||new Date}});o({groups:c,loading:!1,error:null})}catch{o({loading:!1,error:"Failed to refresh groups"})}})()},createGroup:async(e,t)=>{o({loading:!0,error:null});try{const r=await X.createGroup(e,t);if(u("GroupStore: Create group result",r),r.error)throw ee("GroupStore: Create group failed",r.error),o({error:r.error,loading:!1}),new Error(r.error);u("GroupStore: Group created successfully",r.id),o({loading:!1})}catch(r){throw o({error:r.message,loading:!1}),r}},updateGroup:async(e,t,r)=>{try{const a=await X.updateGroup(e,t,r);a.error&&o({error:a.error})}catch(a){const i=A(a);o({error:i})}},deleteGroup:async(e,t)=>{try{const r=await X.deleteGroup(e,t);if(r.error)throw o({error:r.error}),new Error(r.error)}catch(r){const a=A(r);throw o({error:a}),r}},getGroupById:e=>{const{groups:t}=s();return t.find(r=>r.id===e)},getDefaultGroup:()=>{const{groups:e}=s();return e.find(t=>t.name==="Default"||t.name==="Nh√≥m m·∫∑c ƒë·ªãnh")||{id:"default",name:"Default",color:"#6B7280",icon:"üìã",userId:"",createdAt:new Date}}}));var w=(o=>(o.LOW="low",o.MEDIUM="medium",o.HIGH="high",o.URGENT="urgent",o))(w||{}),se=(o=>(o.TODO="todo",o.IN_PROGRESS="in-progress",o.COMPLETED="completed",o.CANCELLED="cancelled",o))(se||{});const he=(o,s)=>{const e=o.data();return{id:o.id,userId:s,...e,startDate:e.startDate?.toDate?.()||null,dueDate:e.dueDate?.toDate?.()||null,createdAt:e.createdAt?.toDate?.()||new Date,updatedAt:e.updatedAt?.toDate?.()||new Date,completedAt:e.completedAt?.toDate?.()||null}},B=new Map,lt=5*60*1e3;class dt{getTasksCollection(s){return te(W,"users",s,"tasks")}getCachedQuery(s){const e=B.get(s);return e&&Date.now()-e.timestamp<e.ttl?e.data:(e&&B.delete(s),null)}setCachedQuery(s,e,t=lt){if(B.set(s,{data:e,timestamp:Date.now(),ttl:t}),u("TaskService: Cached query result",{count:e.length}),B.size>20){const r=B.keys().next().value;r&&B.delete(r)}}clearUserCache(s){const e=Array.from(B.keys()).filter(t=>t.includes(s));e.forEach(t=>B.delete(t)),u("TaskService: Cleared cache for user",{deletedKeys:e.length})}async createTask(s,e){try{u("TaskService: Creating task",{userId:s,taskData:e});const t={...e,startDate:e.startDate?Q.fromDate(e.startDate):null,dueDate:e.dueDate?Q.fromDate(e.dueDate):null,completedAt:e.completedAt?Q.fromDate(e.completedAt):null,createdAt:I(),updatedAt:I()};u("TaskService: Firestore data",t);const r=await Te(this.getTasksCollection(s),t);return u("TaskService: Task created with ID",r.id),{id:r.id,error:null}}catch(t){return{id:null,error:A(t)}}}async updateTask(s,e,t){try{u("TaskService: Updating task",{userId:s,taskId:e,updates:t});const r=Z(this.getTasksCollection(s),e),a={};Object.keys(t).forEach(c=>{const l=t[c];l!==void 0&&(a[c]=l)});const i={...a,updatedAt:I()};return t.startDate!==void 0&&(i.startDate=t.startDate?Q.fromDate(t.startDate):null),t.dueDate!==void 0&&(i.dueDate=t.dueDate?Q.fromDate(t.dueDate):null),t.completedAt!==void 0&&(i.completedAt=t.completedAt?Q.fromDate(t.completedAt):null),u("TaskService: Clean update data",i),await Se(r,i),u("TaskService: Task updated successfully"),{error:null}}catch(r){return{error:A(r)}}}async deleteTask(s,e){try{const t=Z(this.getTasksCollection(s),e);return await nt(t),{error:null}}catch(t){return{error:A(t)}}}async toggleTaskCompletion(s,e,t){try{u("TaskService: Toggling task completion",{userId:s,taskId:e,isCompleted:t});const r={isCompleted:t,status:t?se.COMPLETED:se.TODO,completedAt:t?new Date:null};u("TaskService: Update data for toggle",r);const a=await this.updateTask(s,e,r);return a.error?ee("TaskService: Toggle completion failed",a.error):u("TaskService: Toggle completion successful"),a}catch(r){return{error:A(r)}}}subscribeToTasks(s,e,t){const r=`tasks_${s}_all`,a=this.getCachedQuery(r);a&&(u("TaskService: Returning cached tasks immediately",{count:a.length}),e(a));const i=L(this.getTasksCollection(s),oe("createdAt","desc"),...t?[ge(t)]:[]);return pe(i,c=>{u("TaskService: Received snapshot",{size:c.size,empty:c.empty,changes:c.docChanges().length});const l=c.docs.map(p=>{const g=he(p,s);return u("TaskService: Converted task",{id:g.id,title:g.title}),g});this.setCachedQuery(r,l),u("TaskService: Calling callback with tasks",l.length),e(l)},c=>{e(a||[])})}subscribeToFilteredTasks(s,e,t,r){const a=JSON.stringify(e),i=`filtered_${s}_${a}`,c=this.getCachedQuery(i);c&&(u("TaskService: Returning cached filtered tasks",{count:c.length}),t(c));let l=L(this.getTasksCollection(s));return e.status&&e.status.length>0&&(l=L(l,ne("status","in",e.status))),e.priority&&e.priority.length>0&&(l=L(l,ne("priority","in",e.priority))),e.groupId&&(l=L(l,ne("groupId","==",e.groupId))),e.searchQuery&&u("TaskService: Search query will be handled client-side",{query:e.searchQuery}),l=L(l,oe("createdAt","desc")),r&&(l=L(l,ge(r))),pe(l,p=>{let g=p.docs.map(m=>he(m,s));if(e.searchQuery){const m=e.searchQuery.toLowerCase();g=g.filter(f=>f.title.toLowerCase().includes(m)||f.description?.toLowerCase().includes(m))}e.dateRange&&(g=g.filter(m=>m.dueDate?m.dueDate>=e.dateRange.start&&m.dueDate<=e.dateRange.end:!1)),this.setCachedQuery(i,g),u("TaskService: Filtered tasks computed and cached",{originalCount:p.size,filteredCount:g.length}),t(g)})}async getTasksPage(s,e=20,t){try{u("TaskService: Getting paginated tasks",{userId:s,pageSize:e,hasStartAfter:!!t});let r=L(this.getTasksCollection(s),oe("createdAt","desc"),ge(e));t&&(r=L(r,ot(t)));const a=await Ce(r),i=a.docs.map(p=>he(p,s)),c=a.docs.length===e,l=a.docs.length>0?a.docs[a.docs.length-1]:void 0;return u("TaskService: Paginated tasks loaded",{count:i.length,hasMore:c,hasLastDoc:!!l}),{tasks:i,hasMore:c,lastDoc:l}}catch(r){throw r}}}const z=new dt;class ut{db=null;dbName="TodoAppCache";dbVersion=1;storeName="cache_entries";defaultTTL=60*60*1e3;maxCacheSize=50*1024*1024;isInitialized=!1;constructor(){this.initializeDB()}async initializeDB(){return new Promise(s=>{if(!window.indexedDB){console.warn("IndexedDB not supported, falling back to localStorage"),this.isInitialized=!0,s();return}const e=indexedDB.open(this.dbName,this.dbVersion);e.onerror=()=>{console.warn("IndexedDB failed, falling back to localStorage"),this.isInitialized=!0,s()},e.onsuccess=t=>{this.db=t.target.result,this.isInitialized=!0,this.cleanupExpiredEntries(),s()},e.onupgradeneeded=t=>{const r=t.target.result;if(!r.objectStoreNames.contains(this.storeName)){const a=r.createObjectStore(this.storeName,{keyPath:"key"});a.createIndex("timestamp","timestamp",{unique:!1}),a.createIndex("ttl","ttl",{unique:!1})}}})}async ensureInitialized(){this.isInitialized||await this.initializeDB()}async set(s,e,t={}){await this.ensureInitialized();const r={key:s,data:e,timestamp:Date.now(),ttl:t.ttl||this.defaultTTL,metadata:{size:this.calculateSize(e),type:typeof e,lastAccessed:Date.now()}};await this.enforceCacheSize(),this.db?await this.setIndexedDB(r):this.setLocalStorage(r),console.log("CacheManager: Set cache entry",{key:s,size:r.metadata?.size})}async get(s){await this.ensureInitialized();let e=null;return this.db?e=await this.getIndexedDB(s):e=this.getLocalStorage(s),e?Date.now()-e.timestamp>e.ttl?(await this.delete(s),null):(e.metadata&&(e.metadata.lastAccessed=Date.now(),await this.updateEntry(e)),console.log("CacheManager: Cache hit for key",{key:s}),e.data):null}async delete(s){await this.ensureInitialized(),this.db?await this.deleteIndexedDB(s):this.deleteLocalStorage(s),console.log("CacheManager: Deleted cache entry",{key:s})}async clear(){await this.ensureInitialized(),this.db?await this.clearIndexedDB():this.clearLocalStorage(),console.log("CacheManager: Cleared all cache entries")}async getStats(){return await this.ensureInitialized(),this.db?await this.getIndexedDBStats():this.getLocalStorageStats()}async setIndexedDB(s){return new Promise((e,t)=>{if(!this.db)return t(new Error("Database not initialized"));const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).put(s);i.onsuccess=()=>e(),i.onerror=()=>t(i.error)})}async getIndexedDB(s){return new Promise((e,t)=>{if(!this.db)return e(null);const i=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).get(s);i.onsuccess=()=>e(i.result||null),i.onerror=()=>t(i.error)})}async deleteIndexedDB(s){return new Promise((e,t)=>{if(!this.db)return e();const i=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).delete(s);i.onsuccess=()=>e(),i.onerror=()=>t(i.error)})}async clearIndexedDB(){return new Promise((s,e)=>{if(!this.db)return s();const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).clear();a.onsuccess=()=>s(),a.onerror=()=>e(a.error)})}async getIndexedDBStats(){return new Promise((s,e)=>{if(!this.db)return s({entries:0,totalSize:0});const a=this.db.transaction([this.storeName],"readonly").objectStore(this.storeName).getAll();a.onsuccess=()=>{const i=a.result;let c=0;i.forEach(l=>{c+=l.metadata?.size||0}),s({entries:i.length,totalSize:c})},a.onerror=()=>e(a.error)})}setLocalStorage(s){try{const e=`cache_${s.key}`;localStorage.setItem(e,JSON.stringify(s))}catch(e){console.warn("localStorage cache failed:",e)}}getLocalStorage(s){try{const e=`cache_${s}`,t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(e){return console.warn("localStorage cache read failed:",e),null}}deleteLocalStorage(s){try{const e=`cache_${s}`;localStorage.removeItem(e)}catch(e){console.warn("localStorage cache delete failed:",e)}}clearLocalStorage(){try{Object.keys(localStorage).filter(e=>e.startsWith("cache_")).forEach(e=>localStorage.removeItem(e))}catch(s){console.warn("localStorage cache clear failed:",s)}}getLocalStorageStats(){try{const s=Object.keys(localStorage).filter(t=>t.startsWith("cache_"));let e=0;return s.forEach(t=>{const r=localStorage.getItem(t);r&&(e+=new Blob([r]).size)}),{entries:s.length,totalSize:e}}catch(s){return console.warn("localStorage stats failed:",s),{entries:0,totalSize:0}}}calculateSize(s){try{return new Blob([JSON.stringify(s)]).size}catch{return 0}}async updateEntry(s){this.db?await this.setIndexedDB(s):this.setLocalStorage(s)}async cleanupExpiredEntries(){if(!this.db)return;const t=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp"),r=IDBKeyRange.upperBound(Date.now()),a=t.openCursor(r);a.onsuccess=i=>{const c=i.target.result;c&&(c.delete(),c.continue())}}async enforceCacheSize(){if((await this.getStats()).totalSize>this.maxCacheSize&&(console.log("CacheManager: Cache size exceeded, cleaning up..."),this.db)){const a=this.db.transaction([this.storeName],"readwrite").objectStore(this.storeName).index("timestamp").openCursor();let i=0;a.onsuccess=c=>{const l=c.target.result;l&&i<10&&(l.delete(),i++,l.continue())}}}}const K=new ut;class gt{pendingOperations=[];isOnline=navigator.onLine;syncInProgress=!1;constructor(){this.initialize(),this.loadPendingOperations()}initialize(){window.addEventListener("online",()=>{console.log("BackgroundSync: Online detected, starting sync..."),this.isOnline=!0,this.syncPendingOperations()}),window.addEventListener("offline",()=>{console.log("BackgroundSync: Offline detected"),this.isOnline=!1}),setInterval(()=>{this.isOnline&&!this.syncInProgress&&this.pendingOperations.length>0&&this.syncPendingOperations()},3e4)}async addPendingOperation(s,e,t,r=3){const a={id:`${s}_${e}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:s,collection:e,data:t,timestamp:Date.now(),retryCount:0,maxRetries:r};return this.pendingOperations.push(a),await this.savePendingOperations(),console.log("BackgroundSync: Added pending operation",{id:a.id,type:s,collection:e}),this.isOnline&&this.syncPendingOperations(),a.id}async syncPendingOperations(){if(this.syncInProgress||!this.isOnline||this.pendingOperations.length===0)return;this.syncInProgress=!0,console.log(`BackgroundSync: Starting sync of ${this.pendingOperations.length} operations`);const s=[...this.pendingOperations],e=[],t=[];for(const r of s)try{await this.executeOperation(r),e.push(r.id),console.log("BackgroundSync: Operation completed",{id:r.id})}catch(a){r.retryCount++;const i=a instanceof Error?a.message:String(a);r.retryCount>=r.maxRetries?(console.error("BackgroundSync: Operation failed permanently",{id:r.id,error:i}),t.push(r.id)):console.warn("BackgroundSync: Operation failed, will retry",{id:r.id,retryCount:r.retryCount,error:i})}this.pendingOperations=this.pendingOperations.filter(r=>!e.includes(r.id)),this.pendingOperations=this.pendingOperations.filter(r=>!t.includes(r.id)),await this.savePendingOperations(),this.syncInProgress=!1,console.log("BackgroundSync: Sync completed",{processed:s.length,successful:e.length,failed:t.length,remaining:this.pendingOperations.length})}async executeOperation(s){switch(s.type){case"create":console.log(`BackgroundSync: Creating ${s.collection}`,s.data);break;case"update":console.log(`BackgroundSync: Updating ${s.collection}`,s.data);break;case"delete":console.log(`BackgroundSync: Deleting ${s.collection}`,s.data);break;default:throw new Error(`Unknown operation type: ${s.type}`)}await new Promise(e=>setTimeout(e,100))}getPendingCount(){return this.pendingOperations.length}getPendingOperations(){return[...this.pendingOperations]}async clearPendingOperations(){this.pendingOperations=[],await this.savePendingOperations(),console.log("BackgroundSync: Cleared all pending operations")}isCurrentlySyncing(){return this.syncInProgress}getSyncStatus(){return{isOnline:this.isOnline,pendingCount:this.pendingOperations.length,isSyncing:this.syncInProgress}}async loadPendingOperations(){try{const s=await K.get("pending_operations");s&&(this.pendingOperations=s,console.log(`BackgroundSync: Loaded ${s.length} pending operations from cache`))}catch(s){console.warn("BackgroundSync: Failed to load pending operations",s)}}async savePendingOperations(){try{await K.set("pending_operations",this.pendingOperations,{ttl:24*60*60*1e3})}catch(s){console.warn("BackgroundSync: Failed to save pending operations",s)}}}const Y=new gt,_=new Map;let ve="";const Oe=De((o,s)=>({tasks:[],loading:!1,error:null,filters:{},sort:{field:"createdAt",direction:"desc"},unsubscribe:null,setTasks:e=>o({tasks:e}),setLoading:e=>o({loading:e}),setError:e=>o({error:e}),setFilters:e=>o({filters:e}),setSort:e=>o({sort:e}),setUnsubscribe:e=>o({unsubscribe:e}),fetchTasks:()=>{const{unsubscribe:e,loading:t}=s();if(t)return;e&&e(),o({loading:!0,error:null});const a=re.getState().user;if(!a){o({loading:!1,error:"User not authenticated"});return}const i=async(c=3)=>{try{await new Promise(p=>setTimeout(p,300)),u("TaskStore: Setting up real-time listener for tasks");const l=z.subscribeToTasks(a.uid,p=>{u("TaskStore: Received real-time tasks update",{count:p.length}),o({tasks:p,loading:!1,error:null})});o({unsubscribe:l}),u("TaskStore: Real-time listener setup complete")}catch(l){if(l.code==="permission-denied"&&c>0){setTimeout(()=>i(c-1),1e3);return}o({loading:!1,error:"Failed to load tasks. Please try refreshing the page."})}};i()},refreshTasks:()=>{s().fetchTasks()},cleanup:()=>{const{unsubscribe:e}=s();e&&(e(),o({unsubscribe:null}))},createTask:async(e,t)=>{o({loading:!0,error:null});try{const r=await z.createTask(e,t);if(u("TaskStore: Create task result",r),r.error){if(ee("TaskStore: Create task failed",r.error),!navigator.onLine||r.error.includes("network")){u("TaskStore: Adding to background sync queue"),await Y.addPendingOperation("create","tasks",{userId:e,...t});const a={id:`temp_${Date.now()}`,userId:e,title:t.title,description:t.description,status:t.status||se.TODO,priority:t.priority||w.MEDIUM,isCompleted:!1,startDate:t.startDate,dueDate:t.dueDate,groupId:t.groupId,createdAt:new Date,updatedAt:new Date,completedAt:null};await K.set(`task_${a.id}`,a,{ttl:24*60*60*1e3}),u("TaskStore: Task added to cache for offline sync")}throw o({error:r.error,loading:!1}),new Error(r.error)}else u("TaskStore: Task created successfully",r.id),z.clearUserCache(e),o({loading:!1})}catch(r){throw navigator.onLine||await Y.addPendingOperation("create","tasks",{userId:e,...t}),o({error:r.message,loading:!1}),r}},updateTask:async(e,t,r)=>{try{u("TaskStore: Updating task",{userId:e,taskId:t,updates:r});const a=await z.updateTask(e,t,r);if(a.error)throw ee("TaskStore: Update task failed",a.error),o({error:a.error}),new Error(a.error);u("TaskStore: Update task successful"),z.clearUserCache(e)}catch(a){throw o({error:a.message}),a}},deleteTask:async(e,t)=>{try{const r=await z.deleteTask(e,t);if(r.error)throw o({error:r.error}),new Error(r.error);z.clearUserCache(e)}catch(r){throw o({error:r.message}),r}},toggleTaskCompletion:async(e,t,r)=>{try{u("TaskStore: Toggling task completion",{taskId:t,isCompleted:r});const a=await z.toggleTaskCompletion(e,t,r);if(a.error)throw ee("TaskStore: Toggle completion failed",a.error),o({error:a.error}),new Error(a.error);u("TaskStore: Toggle completion successful")}catch(a){throw o({error:a.message}),a}},getFilteredTasks:()=>{const{tasks:e,filters:t,sort:r}=s(),a=JSON.stringify({taskCount:e.length,filters:t,sort:r,taskIds:e.map(c=>c.id).sort().join(",")});if(_.has(a)&&a===ve)return _.get(a);let i=[...e];if(t.status&&t.status.length>0&&(i=i.filter(c=>t.status.includes(c.status))),t.priority&&t.priority.length>0&&(i=i.filter(c=>t.priority.includes(c.priority))),t.groupId&&(i=i.filter(c=>c.groupId===t.groupId)),t.searchQuery){const c=t.searchQuery.toLowerCase();i=i.filter(l=>l.title.toLowerCase().includes(c)||l.description?.toLowerCase().includes(c))}if(t.dateRange&&(i=i.filter(c=>c.dueDate?c.dueDate>=t.dateRange.start&&c.dueDate<=t.dateRange.end:!1)),i.sort((c,l)=>{let p,g;switch(r.field){case"dueDate":p=c.dueDate?.getTime()||0,g=l.dueDate?.getTime()||0;break;case"createdAt":p=c.createdAt.getTime(),g=l.createdAt.getTime();break;case"priority":const m={[w.URGENT]:4,[w.HIGH]:3,[w.MEDIUM]:2,[w.LOW]:1};p=m[c.priority],g=m[l.priority];break;case"title":p=c.title.toLowerCase(),g=l.title.toLowerCase();break;default:return 0}return r.direction==="asc"?p>g?1:-1:p<g?1:-1}),_.set(a,i),ve=a,_.size>10){const c=_.keys().next().value;c&&_.delete(c)}return u("TaskStore: Filtered tasks computed and cached",{originalCount:e.length,filteredCount:i.length,cacheSize:_.size}),i},getTasksByStatus:e=>{const{tasks:t}=s();return t.filter(r=>r.status===e)},getOverdueTasks:()=>{const{tasks:e}=s(),t=new Date;return e.filter(r=>r.dueDate&&r.dueDate<t&&r.status!==se.COMPLETED)},getCacheStats:async()=>{try{const e=await K.getStats();return u("TaskStore: Cache stats retrieved",e),e}catch{return{entries:0,totalSize:0}}},clearCache:async()=>{try{await K.clear(),u("TaskStore: Cache cleared successfully")}catch{}},preloadCache:async e=>{try{u("TaskStore: Preloading cache for user",e);const t=await K.get(`tasks_${e}_all`);t&&Array.isArray(t)&&u("TaskStore: Cache preloaded with tasks",{count:t.length}),await K.get(`user_settings_${e}`)&&u("TaskStore: User settings preloaded from cache")}catch{}},getSyncStatus:()=>Y.getSyncStatus(),getPendingOperations:()=>Y.getPendingOperations(),forceSync:async()=>{try{u("TaskStore: Forcing background sync"),await Y.syncPendingOperations(),u("TaskStore: Background sync completed")}catch(e){throw e}}})),Ee=({isOpen:o,onClose:s,title:e,children:t,className:r=""})=>{const a=y.useRef(null),i=y.useRef(null);return y.useEffect(()=>{if(!o)return;const c=a.current;if(!c)return;i.current?.focus();const l=c.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),p=l[0],g=l[l.length-1],m=b=>{b.key==="Tab"&&(b.shiftKey?document.activeElement===p&&(b.preventDefault(),g?.focus()):document.activeElement===g&&(b.preventDefault(),p?.focus()))},f=b=>{b.key==="Escape"&&s()};return document.addEventListener("keydown",m),document.addEventListener("keydown",f),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",m),document.removeEventListener("keydown",f),document.body.style.overflow="unset"}},[o,s]),o?n.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",onClick:s,children:n.jsxs("div",{ref:a,className:`relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800 ${r}`,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",onClick:c=>c.stopPropagation(),children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsx("h3",{ref:i,id:"modal-title",className:"text-lg font-medium text-gray-900 dark:text-white",tabIndex:-1,children:e}),n.jsx("button",{onClick:s,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300","aria-label":"ƒê√≥ng modal",children:n.jsx(Je,{className:"w-6 h-6"})})]}),t]})}):null},ht=({isOpen:o,onClose:s,onConfirm:e,title:t,message:r,confirmText:a="X√°c nh·∫≠n",cancelText:i="H·ªßy",variant:c="danger",loading:l=!1})=>{const p=()=>{e(),s()},g={danger:"bg-red-600 hover:bg-red-700 text-white focus:ring-red-500",warning:"bg-yellow-600 hover:bg-yellow-700 text-white focus:ring-yellow-500",info:"bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500"},m={danger:"text-red-600",warning:"text-yellow-600",info:"text-blue-600"},f={danger:n.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),warning:n.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),info:n.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})};return n.jsxs(Ee,{isOpen:o,onClose:s,title:t,children:[n.jsx("div",{className:"mb-6",children:n.jsxs("div",{className:"flex items-start space-x-3",children:[n.jsx("div",{className:`flex-shrink-0 ${m[c]}`,children:f[c]}),n.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm leading-relaxed",children:r})]})}),n.jsxs("div",{className:"flex justify-end space-x-3",children:[n.jsx("button",{onClick:s,className:"btn-secondary",disabled:l,children:i}),n.jsx("button",{onClick:p,disabled:l,className:`px-4 py-2 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed ${g[c]}`,children:l?n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),n.jsx("span",{children:"ƒêang x·ª≠ l√Ω..."})]}):a})]})]})},pt=()=>{const[o,s]=y.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}});return{confirm:(r,a,i,c="danger",l)=>{s({isOpen:!0,title:r,message:a,onConfirm:i,variant:c,confirmText:l})},ConfirmComponent:()=>n.jsx(ht,{isOpen:o.isOpen,onClose:()=>s(r=>({...r,isOpen:!1})),onConfirm:o.onConfirm,title:o.title,message:o.message,variant:o.variant,confirmText:o.confirmText})}},Le=y.createContext(null),Ct=({children:o})=>{const[s,e]=y.useState([]),t=y.useCallback((a,i,c=5e3)=>{const l=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,p={id:l,message:a,type:i,duration:c};e(g=>[...g,p]),setTimeout(()=>{e(g=>g.filter(m=>m.id!==l))},c)},[]),r=a=>{e(i=>i.filter(c=>c.id!==a))};return n.jsxs(Le.Provider,{value:{showToast:t},children:[o,n.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:s.map(a=>n.jsx(mt,{toast:a,onClose:()=>r(a.id)},a.id))})]})},mt=({toast:o,onClose:s})=>{const e={success:Ye,error:we,warning:Xe},t={success:"bg-green-50 text-green-800 border-green-200 dark:bg-green-900/20 dark:text-green-200 dark:border-green-800",error:"bg-red-50 text-red-800 border-red-200 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800",warning:"bg-yellow-50 text-yellow-800 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-200 dark:border-yellow-800"},r=e[o.type];return n.jsx("div",{className:`p-4 rounded-lg border shadow-lg max-w-sm transform transition-all duration-300 ease-in-out ${t[o.type]}`,children:n.jsxs("div",{className:"flex items-center",children:[n.jsx(r,{className:"w-5 h-5 mr-3 flex-shrink-0"}),n.jsx("p",{className:"text-sm font-medium flex-1",children:o.message}),n.jsx("button",{onClick:s,className:"ml-3 text-current hover:opacity-70 transition-opacity","aria-label":"ƒê√≥ng th√¥ng b√°o",children:n.jsx(we,{className:"w-4 h-4"})})]})})},Me=()=>{const o=y.useContext(Le);if(!o)throw new Error("useToast must be used within ToastProvider");return o};function ft(o,s){const e=new Date;e.setHours(0,0,0,0);const t=new Date(s);if(t.setHours(0,0,0,0),o.isCompleted)return{task:o,displayDate:t,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:!1};if(!o.startDate){if(!o.dueDate)return{task:o,displayDate:t,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:!1};const f=new Date(o.dueDate);f.setHours(0,0,0,0);const b=f<e,C=f.getTime()===t.getTime();return{task:o,displayDate:t,isOverdue:b,isUrgent:b,urgencyLevel:b?"critical":"normal",shouldDisplay:C}}const r=new Date(o.startDate);r.setHours(0,0,0,0);const a=o.dueDate?new Date(o.dueDate):null;if(a&&a.setHours(0,0,0,0),e<r){const f=t.getTime()===r.getTime();return{task:o,displayDate:r,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:f}}if(a&&e>a){const f=t.getTime()===a.getTime();return{task:o,displayDate:a,isOverdue:!0,isUrgent:!0,urgencyLevel:"critical",shouldDisplay:f}}const i=t.getTime()===e.getTime();if(!a)return{task:o,displayDate:e,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:i};const c=Math.max(1,Math.ceil((a.getTime()-r.getTime())/(1e3*60*60*24))),l=Math.ceil((a.getTime()-e.getTime())/(1e3*60*60*24)),p=(c-l)/c;let g="normal",m=!1;return l<=1?(g="critical",m=!0):l<=3||p>=.8?(g="urgent",m=!0):p>=.6&&(g="urgent",m=!1),{task:o,displayDate:e,isOverdue:!1,isUrgent:m,urgencyLevel:g,shouldDisplay:i}}function Ge(o,s){return o.map(e=>ft(e,s)).filter(e=>e.shouldDisplay)}function yt(o,s){return s==="critical"?w.URGENT:s==="urgent"&&o.priority!==w.URGENT?w.HIGH:o.priority}const xt=({isOpen:o,onClose:s,selectedDate:e,tasks:t})=>{const{getGroupById:r}=Ne(),{deleteTask:a}=Oe(),{user:i}=re(),{confirm:c,ConfirmComponent:l}=pt(),{showToast:p}=Me(),[g,m]=y.useState(null),[f,b]=y.useState(!1);if(!e)return null;const M=Ge(t,e).sort((h,j)=>{if(h.urgencyLevel!==j.urgencyLevel){const G={critical:3,urgent:2,normal:1};return G[j.urgencyLevel]-G[h.urgencyLevel]}const T={[w.URGENT]:4,[w.HIGH]:3,[w.MEDIUM]:2,[w.LOW]:1};return T[j.task.priority]-T[h.task.priority]}),ae=h=>h.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),ie=h=>{switch(h){case w.URGENT:return"bg-red-500";case w.HIGH:return"bg-orange-500";case w.MEDIUM:return"bg-yellow-500";case w.LOW:return"bg-green-500";default:return"bg-gray-500"}},ce=h=>{switch(h){case w.URGENT:return"Kh·∫©n c·∫•p";case w.HIGH:return"Cao";case w.MEDIUM:return"Trung b√¨nh";case w.LOW:return"Th·∫•p";default:return"Kh√¥ng x√°c ƒë·ªãnh"}},U=h=>{switch(h){case"critical":return"C·ª±c k·ª≥ kh·∫©n c·∫•p";case"urgent":return"Kh·∫©n c·∫•p";default:return""}},le=h=>{m(h)},F=h=>{i&&c("X√≥a c√¥ng vi·ªác",`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác "${h.title}"?`,async()=>{b(!0);try{await a(i.uid,h.id),p("ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng","success")}catch{p("C√≥ l·ªói x·∫£y ra khi x√≥a c√¥ng vi·ªác","error")}finally{b(!1)}},"danger","X√≥a c√¥ng vi·ªác")};return n.jsxs(n.Fragment,{children:[n.jsxs(Ee,{isOpen:o&&!g,onClose:s,title:`C√¥ng vi·ªác ng√†y ${ae(e)}`,className:"max-w-2xl",children:[n.jsx("div",{className:"max-h-96 overflow-y-auto",children:M.length===0?n.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:n.jsx("p",{children:"Kh√¥ng c√≥ c√¥ng vi·ªác n√†o trong ng√†y n√†y"})}):n.jsx("div",{className:"space-y-3",children:M.map(({task:h,isOverdue:j,urgencyLevel:T})=>{const G=h.groupId?r(h.groupId):null;return n.jsx("div",{className:`p-4 rounded-lg border ${j?"border-red-300 bg-red-50 dark:border-red-600 dark:bg-red-900/20":T==="critical"?"border-red-200 bg-red-25 dark:border-red-700 dark:bg-red-900/10":T==="urgent"?"border-orange-200 bg-orange-25 dark:border-orange-700 dark:bg-orange-900/10":"border-gray-200 bg-gray-50 dark:border-gray-600 dark:bg-gray-700"}`,children:n.jsxs("div",{className:"flex items-start justify-between",children:[n.jsxs("div",{className:"flex-1 min-w-0",children:[n.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[n.jsx("div",{className:`w-3 h-3 rounded-full ${ie(h.priority)}`}),n.jsx("h3",{className:"font-medium text-gray-900 dark:text-white truncate",children:h.title}),j&&n.jsx("span",{className:"text-red-600 font-bold text-sm",title:"Qu√° h·∫°n",children:"‚ö† Qu√° h·∫°n"}),!j&&T==="critical"&&n.jsxs("span",{className:"text-red-500 font-bold text-sm",title:"C·ª±c k·ª≥ kh·∫©n c·∫•p",children:["üî• ",U(T)]}),!j&&T==="urgent"&&n.jsxs("span",{className:"text-orange-500 font-bold text-sm",title:"Kh·∫©n c·∫•p",children:["‚ö° ",U(T)]})]}),h.description&&n.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:h.description}),n.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs text-gray-500 dark:text-gray-400",children:[n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("span",{children:"ƒê·ªô ∆∞u ti√™n:"}),n.jsx("span",{className:"font-medium",children:ce(h.priority)})]}),G&&n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("span",{children:"Nh√≥m:"}),n.jsxs("span",{className:"font-medium",children:[G.icon," ",G.name]})]}),h.startDate&&n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("span",{children:"B·∫Øt ƒë·∫ßu:"}),n.jsx("span",{className:"font-medium",children:new Date(h.startDate).toLocaleDateString("vi-VN")})]}),h.dueDate&&n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("span",{children:"H·∫°n cu·ªëi:"}),n.jsx("span",{className:"font-medium",children:new Date(h.dueDate).toLocaleDateString("vi-VN")})]})]})]}),n.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[n.jsx("button",{onClick:()=>le(h),className:"text-gray-400 hover:text-blue-600 transition-colors p-1 rounded",title:"Ch·ªânh s·ª≠a c√¥ng vi·ªác",disabled:f,children:n.jsx(Ze,{className:"w-4 h-4"})}),n.jsx("button",{onClick:()=>F(h),className:"text-gray-400 hover:text-red-600 transition-colors p-1 rounded",title:"X√≥a c√¥ng vi·ªác",disabled:f,children:n.jsx(et,{className:"w-4 h-4"})})]})]})},h.id)})})}),M.length>0&&n.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-600",children:n.jsxs("div",{className:"flex justify-between text-sm text-gray-600 dark:text-gray-300",children:[n.jsxs("span",{children:["T·ªïng c·ªông: ",M.length," c√¥ng vi·ªác"]}),n.jsxs("div",{className:"flex space-x-4",children:[M.filter(h=>h.urgencyLevel==="critical"||h.isOverdue).length>0&&n.jsxs("span",{className:"text-red-600",children:["Kh·∫©n c·∫•p: ",M.filter(h=>h.urgencyLevel==="critical"||h.isOverdue).length]}),M.filter(h=>h.urgencyLevel==="urgent"&&!h.isOverdue).length>0&&n.jsxs("span",{className:"text-orange-600",children:["C·∫ßn ch√∫ √Ω: ",M.filter(h=>h.urgencyLevel==="urgent"&&!h.isOverdue).length]})]})]})}),n.jsx(l,{})]}),g&&n.jsx(je,{task:g,onClose:()=>m(null),onSuccess:()=>{m(null),p("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng","success")}})]})},wt=y.memo(({tasks:o})=>{const[s,e]=y.useState(new Date),[t,r]=y.useState(null),[a,i]=y.useState(null),[c,l]=y.useState(null),[p,g]=y.useState(null),[m,f]=y.useState(null),[b,C]=y.useState(null),[M,ae]=y.useState(!1),[ie,ce]=y.useState(null),{user:U}=re(),{getGroupById:le}=Ne(),{filters:F,toggleTaskCompletion:h,updateTask:j}=Oe(),{showToast:T}=Me(),G=y.useMemo(()=>F.groupId?o.filter(d=>d.groupId===F.groupId):o,[o,F.groupId]),N=y.useMemo(()=>{const d=s.getFullYear(),x=s.getMonth(),O=new Date,R=new Date(d,x,1),S=new Date(d,x+1,0),v=S.getDate(),$=R.getDay(),P=new Date(d,x-1,0),de=$,H=[];for(let D=de;D>0;D--){const q=P.getDate()-D+1,ue=new Date(d,x-1,q);H.push({date:ue,day:q,isCurrentMonth:!1,isToday:!1})}for(let D=1;D<=v;D++){const q=new Date(d,x,D),ue=q.toDateString()===O.toDateString();H.push({date:q,day:D,isCurrentMonth:!0,isToday:ue})}const k=42-H.length;for(let D=1;D<=k;D++){const q=new Date(d,x+1,D);H.push({date:q,day:D,isCurrentMonth:!1,isToday:!1})}return{year:d,month:x,calendarDays:H,firstDayOfMonth:R,lastDayOfMonth:S,daysInMonth:v,startingDayOfWeek:$}},[s]),Pe=d=>Ge(G,d),Ie=y.useCallback(()=>{e(new Date(N.year,N.month-1,1))},[N.year,N.month]),Ae=y.useCallback(()=>{e(new Date(N.year,N.month+1,1))},[N.year,N.month]),Re=()=>{e(new Date)},me=d=>{ce(d),ae(!0)},$e=(d,x)=>{d.preventDefault(),d.stopPropagation(),!x.isCompleted&&i({x:d.clientX,y:d.clientY,task:x})},fe=async d=>{if(U)try{await h(U.uid,d.id,!0),i(null),T(`ƒê√£ ho√†n th√†nh c√¥ng vi·ªác "${d.title}"`,"success")}catch(x){console.error("Failed to mark task as done:",x),T("C√≥ l·ªói x·∫£y ra khi ƒë√°nh d·∫•u ho√†n th√†nh","error")}},ye=()=>{i(null),f(null)},Be=(d,x)=>{if(x.isCompleted){d.preventDefault();return}l(x),d.dataTransfer.effectAllowed="move",d.dataTransfer.setData("text/plain",x.id)},ze=(d,x)=>{d.preventDefault(),d.dataTransfer.dropEffect="move",g(x)},Ue=()=>{g(null)},Fe=async(d,x)=>{if(d.preventDefault(),g(null),!c||!U)return;const O=new Date(x);O.setHours(23,59,59,999);try{await j(U.uid,c.id,{dueDate:O}),l(null)}catch(R){console.error("Failed to update task due date:",R),l(null)}},He=()=>{l(null),g(null)},qe=(d,x)=>{if(x.isCompleted)return;const O=d.touches[0],R=setTimeout(()=>{f({task:x,x:O.clientX,y:O.clientY})},500);C(R)},_e=()=>{b&&(clearTimeout(b),C(null))},Ke=()=>{b&&(clearTimeout(b),C(null))};y.useEffect(()=>{if(a||m)return document.addEventListener("click",ye),()=>document.removeEventListener("click",ye)},[a,m]),y.useEffect(()=>()=>{b&&clearTimeout(b)},[b]);const We=d=>{switch(d){case w.URGENT:return"bg-red-500";case w.HIGH:return"bg-orange-500";case w.MEDIUM:return"bg-yellow-500";case w.LOW:return"bg-green-500";default:return"bg-gray-500"}},Qe=["January","February","March","April","May","June","July","August","September","October","November","December"],Ve=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],xe=(()=>{if(F.groupId){const d=le(F.groupId);return d?`${d.icon} ${d.name}`:"Unknown Group"}return null})();return n.jsxs("div",{className:"w-full",children:[n.jsxs("div",{className:"flex items-center justify-between mb-4",children:[n.jsxs("div",{className:"flex items-center space-x-4",children:[n.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:[Qe[N.month]," ",N.year]}),xe&&n.jsxs("span",{className:"text-sm text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 px-2 py-1 rounded-full",children:["Filtered by: ",xe]}),n.jsx("button",{onClick:Re,className:"text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Today"})]}),n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx("button",{onClick:Ie,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:n.jsx(tt,{className:"w-5 h-5"})}),n.jsx("button",{onClick:Ae,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:n.jsx(rt,{className:"w-5 h-5"})})]})]}),n.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:Ve.map(d=>n.jsx("div",{className:"p-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400",children:d},d))}),n.jsx("div",{className:"grid grid-cols-7 gap-1",children:N.calendarDays.map((d,x)=>{const O=Pe(d.date),R=p?.toDateString()===d.date.toDateString();return n.jsxs("div",{className:`min-h-[96px] p-2 border border-gray-200 dark:border-gray-700 rounded-lg transition-colors cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${d.isCurrentMonth?"bg-white dark:bg-gray-800":"bg-gray-50 dark:bg-gray-900"} ${d.isToday?"ring-2 ring-primary-500":""} ${R?"bg-primary-50 dark:bg-primary-900/20 border-primary-300 dark:border-primary-700 border-2":""}`,onDragOver:S=>ze(S,d.date),onDragLeave:Ue,onDrop:S=>Fe(S,d.date),onDoubleClick:()=>me(d.date),title:"Double-click ƒë·ªÉ xem t·∫•t c·∫£ c√¥ng vi·ªác trong ng√†y",children:[n.jsx("div",{className:`text-sm font-medium mb-1 ${d.isCurrentMonth?d.isToday?"text-primary-600 dark:text-primary-400":"text-gray-900 dark:text-white":"text-gray-400 dark:text-gray-600"}`,children:d.day}),n.jsxs("div",{className:"space-y-1",children:[O.slice(0,4).map(S=>{const{task:v,isOverdue:$,urgencyLevel:P}=S,de=yt(v,P),H=()=>$?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 border border-red-300 dark:border-red-700":P==="critical"?"bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 border border-red-200 dark:border-red-800":P==="urgent"?"bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 border border-orange-200 dark:border-orange-800":"bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-200";return n.jsx("div",{draggable:!v.isCompleted,className:`text-xs p-1 rounded truncate transition-all duration-200 ${H()} cursor-move hover:opacity-80 ${c?.id===v.id?"opacity-50 scale-95":""}`,title:`üìã ${v.title}
üìä Status: ${v.status.replace("-"," ")}
${v.dueDate?`üìÖ Due: ${v.dueDate.toLocaleDateString("vi-VN")}`:"üìÖ Due: Not set"}
${v.startDate?`üöÄ Start: ${v.startDate.toLocaleDateString("vi-VN")}`:"üöÄ Start: Not set"}
${$?"‚ö†Ô∏è OVERDUE":P==="critical"?"üî• CRITICAL":P==="urgent"?"‚ö° URGENT":""}`,onDragStart:k=>{k.stopPropagation(),Be(k,v)},onDragEnd:k=>{k.stopPropagation(),He()},onDoubleClick:k=>{k.stopPropagation(),r(v)},onContextMenu:k=>{k.stopPropagation(),$e(k,v)},onTouchStart:k=>{k.stopPropagation(),qe(k,v)},onTouchEnd:k=>{k.stopPropagation(),_e()},onTouchMove:k=>{k.stopPropagation(),Ke()},children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center space-x-1 flex-1 min-w-0",children:[n.jsx("div",{className:`w-2 h-2 rounded-full ${We(de)}`}),n.jsx("span",{className:"truncate",children:v.title}),$&&n.jsx("span",{className:"text-red-600 font-bold",title:"Overdue",children:"‚ö†"}),!$&&P==="critical"&&n.jsx("span",{className:"text-red-500 font-bold",title:"Critical urgency",children:"üî•"}),!$&&P==="urgent"&&n.jsx("span",{className:"text-orange-500 font-bold",title:"Urgent",children:"‚ö°"})]}),n.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600 lg:hidden flex-shrink-0",onClick:k=>{k.stopPropagation();const D=k.currentTarget.getBoundingClientRect();f({task:v,x:D.right,y:D.bottom})},onDoubleClick:k=>k.stopPropagation(),"aria-label":"T√πy ch·ªçn task",children:"‚ãÆ"}),n.jsx("span",{className:"text-gray-400 text-xs hidden lg:block",children:"‚ãÆ‚ãÆ"})]})},v.id)}),O.length>4&&n.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 text-center cursor-pointer hover:text-gray-700 dark:hover:text-gray-300",onClick:S=>{S.stopPropagation(),me(d.date)},onDoubleClick:S=>S.stopPropagation(),title:"Click ƒë·ªÉ xem t·∫•t c·∫£ c√¥ng vi·ªác",children:["+",O.length-4," more"]})]})]},x)})}),n.jsxs("div",{className:"mt-4 flex items-center justify-center space-x-4 text-xs text-gray-500 dark:text-gray-400",children:[n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),n.jsx("span",{children:"Urgent"})]}),n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("div",{className:"w-2 h-2 rounded-full bg-orange-500"}),n.jsx("span",{children:"High"})]}),n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),n.jsx("span",{children:"Medium"})]}),n.jsxs("div",{className:"flex items-center space-x-1",children:[n.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),n.jsx("span",{children:"Low"})]})]}),a&&n.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-1 z-50",style:{left:a.x,top:a.y},onClick:d=>d.stopPropagation(),children:[n.jsxs("button",{onClick:()=>fe(a.task),className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[n.jsx(be,{className:"w-4 h-4 text-green-600"}),n.jsx("span",{children:"Ho√†n th√†nh"})]}),n.jsxs("button",{onClick:()=>{r(a.task),i(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),n.jsx("span",{children:"Ch·ªânh s·ª≠a"})]})]}),m&&n.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-1 z-50",style:{left:m.x,top:m.y},onClick:d=>d.stopPropagation(),children:[n.jsxs("button",{onClick:()=>{fe(m.task),f(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[n.jsx(be,{className:"w-4 h-4 text-green-600"}),n.jsx("span",{children:"Ho√†n th√†nh"})]}),n.jsxs("button",{onClick:()=>{r(m.task),f(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[n.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),n.jsx("span",{children:"Ch·ªânh s·ª≠a"})]})]}),t&&n.jsx(je,{task:t,onClose:()=>r(null),onSuccess:()=>r(null)}),n.jsx(xt,{isOpen:M,onClose:()=>ae(!1),selectedDate:ie,tasks:G})]})}),jt=Object.freeze(Object.defineProperty({__proto__:null,default:wt},Symbol.toStringTag,{value:"Module"}));export{jt as D,Ee as M,w as P,se as T,Oe as a,pt as b,Me as c,Ct as d,Ne as u};
