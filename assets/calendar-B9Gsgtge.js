import{r as v,j as t,F as Je,a as Ye,b as ue,c as Ze,d as _e,e as er,f as rr,g as tr,h as ge}from"./vendor-CvCHbQ4q.js";import{c as pe}from"./state-vendor-BlHBy2Yi.js";import{d as J,f as X,h as sr,j as R,k as fe,l as xe,q as A,w as _,m as ar,n as or,o as ae,p as oe,r as he,T as H,t as nr}from"./firebase-vendor-D-WO-jOu.js";import{d as I,a as h,g as O,b as K,c as Q,u as Y}from"./auth-VFuffwwi.js";import{T as ye}from"./tasks-B0IvL4wu.js";const ir=(o,n)=>{const e=o.data();return{id:o.id,userId:n,...e,createdAt:e.createdAt?.toDate?.()||new Date}};class lr{getGroupsCollection(n){return J(I,"users",n,"groups")}async ensureDefaultGroup(n){try{const e=X(I,"users",n,"groups","default");return await sr(e,{name:"Default",color:"#6B7280",icon:"üìã",createdAt:R(),updatedAt:R()},{merge:!0}),h("GroupService: Ensured default group exists"),"default"}catch(e){throw e}}async createGroup(n,e){try{h("GroupService: Creating group",{userId:n,groupData:e});const s={...e,createdAt:R(),updatedAt:R()};h("GroupService: Firestore data",s);const r=await fe(this.getGroupsCollection(n),s);return h("GroupService: Group created with ID",r.id),{id:r.id,error:null}}catch(s){return{id:null,error:O(s)}}}async updateGroup(n,e,s){try{const r=X(this.getGroupsCollection(n),e),a={...s,updatedAt:R()};return await xe(r,a),{error:null}}catch(r){return{error:O(r)}}}async deleteGroup(n,e){if(e==="default")return{error:"Kh√¥ng th·ªÉ x√≥a nh√≥m m·∫∑c ƒë·ªãnh"};try{const s="default",r=A(J(I,"users",n,"tasks"),_("groupId","==",e)),a=await ar(r),i=or(I);a.docs.forEach(d=>{i.update(d.ref,{groupId:s,updatedAt:R()})});const c=X(this.getGroupsCollection(n),e);return i.delete(c),await i.commit(),h("GroupService: Group deleted and tasks moved to default",{groupId:e,tasksCount:a.size}),{error:null}}catch(s){return{error:O(s)}}}subscribeToGroups(n,e){const s=A(this.getGroupsCollection(n),ae("createdAt","asc"));return oe(s,r=>{h("GroupService: Received snapshot",{size:r.size,empty:r.empty,changes:r.docChanges().length});const a=r.docs.map(i=>{const c=ir(i,n);return h("GroupService: Converted group",{id:c.id,name:c.name}),c});h("GroupService: Calling callback with groups",a.length),e(a)},r=>{e([])})}}const V=new lr;class P{static instance;authStateHistory=[];static getInstance(){return P.instance||(P.instance=new P),P.instance}async logAuthState(n){const e=K.currentUser;let s=null,r=!1;try{e&&(s=await e.getIdToken(),r=!0)}catch{}const a={timestamp:Date.now(),user:e?{uid:e.uid,email:e.email,emailVerified:e.emailVerified}:null,token:s?s.substring(0,20)+"...":null,ready:r};return this.authStateHistory.push(a),h(`üîç Auth State [${n}]:`,{timestamp:new Date().toISOString()}),a}logFirestoreOperation(n,e,s){return{operation:n,userId:e,timestamp:Date.now(),error:s?{code:s.code,message:s.message}:null}}getDebugReport(){return{authHistory:this.authStateHistory,currentAuth:{user:K.currentUser?{uid:K.currentUser.uid,email:K.currentUser.email}:null,timestamp:Date.now()}}}async waitForAuthReady(n=5e3){const e=Date.now();for(;Date.now()-e<n;){const s=K.currentUser;if(s)try{return await s.getIdToken(),h("üéâ Auth is ready!",{uid:s.uid,waitTime:Date.now()-e}),!0}catch{}await new Promise(r=>setTimeout(r,100))}return!1}}const C=P.getInstance(),be=pe((o,n)=>({groups:[],loading:!1,error:null,unsubscribe:null,isRealtimeMode:!0,setGroups:e=>o({groups:e}),setLoading:e=>o({loading:e}),setError:e=>o({error:e}),setUnsubscribe:e=>o({unsubscribe:e}),setRealtimeMode:e=>o({isRealtimeMode:e}),fetchGroups:()=>{const{unsubscribe:e,loading:s}=n();if(s)return;e&&e(),o({loading:!0,error:null});const a=Y.getState().user;if(!a){o({loading:!1,error:"User not authenticated"});return}const i=async(c=3)=>{try{if(await C.logAuthState(`GroupStore-fetchGroups-attempt-${4-c}`),!await C.waitForAuthReady(2e3))throw new Error("Auth timeout - user not ready");C.logFirestoreOperation("ensureDefaultGroup-start",a.uid),await V.ensureDefaultGroup(a.uid),C.logFirestoreOperation("ensureDefaultGroup-success",a.uid),C.logFirestoreOperation("subscribeToGroups-start",a.uid);try{const g=V.subscribeToGroups(a.uid,m=>{C.logFirestoreOperation("subscribeToGroups-callback",a.uid),o({groups:m,loading:!1,error:null})});o({unsubscribe:g,isRealtimeMode:!0}),C.logFirestoreOperation("subscribeToGroups-success",a.uid)}catch(g){C.logFirestoreOperation("subscribeToGroups-fallback",a.uid,g);try{const m=J(I,"users",a.uid,"groups"),b=(await he(m)).docs.map(x=>{const j=x.data();return{id:x.id,userId:a.uid,name:j.name,color:j.color,icon:j.icon,createdAt:j.createdAt?.toDate?.()||new Date}});o({groups:b,loading:!1,error:null,isRealtimeMode:!1}),C.logFirestoreOperation("getGroups-fallback-success",a.uid)}catch(m){C.logFirestoreOperation("getGroups-fallback-error",a.uid,m),o({loading:!1,error:"Failed to load groups",isRealtimeMode:!1})}}}catch(d){if(C.logFirestoreOperation("fetchGroups-error",a.uid,d),d.code==="permission-denied"&&c>0){setTimeout(()=>i(c-1),1e3);return}o({loading:!1,error:"Failed to load groups. Please try refreshing the page."})}};i()},refreshGroups:()=>{const s=Y.getState().user;if(!s)return;o({loading:!0}),(async()=>{try{const a=J(I,"users",s.uid,"groups"),c=(await he(a)).docs.map(d=>{const g=d.data();return{id:d.id,userId:s.uid,name:g.name,color:g.color,icon:g.icon,createdAt:g.createdAt?.toDate?.()||new Date}});o({groups:c,loading:!1,error:null})}catch{o({loading:!1,error:"Failed to refresh groups"})}})()},createGroup:async(e,s)=>{o({loading:!0,error:null});try{const r=await V.createGroup(e,s);if(h("GroupStore: Create group result",r),r.error)throw Q("GroupStore: Create group failed",r.error),o({error:r.error,loading:!1}),new Error(r.error);h("GroupStore: Group created successfully",r.id),o({loading:!1})}catch(r){throw o({error:r.message,loading:!1}),r}},updateGroup:async(e,s,r)=>{try{const a=await V.updateGroup(e,s,r);a.error&&o({error:a.error})}catch(a){const i=O(a);o({error:i})}},deleteGroup:async(e,s)=>{try{const r=await V.deleteGroup(e,s);if(r.error)throw o({error:r.error}),new Error(r.error)}catch(r){const a=O(r);throw o({error:a}),r}},getGroupById:e=>{const{groups:s}=n();return s.find(r=>r.id===e)},getDefaultGroup:()=>{const{groups:e}=n();return e.find(s=>s.name==="Default"||s.name==="Nh√≥m m·∫∑c ƒë·ªãnh")||{id:"default",name:"Default",color:"#6B7280",icon:"üìã",userId:"",createdAt:new Date}}}));var y=(o=>(o.LOW="low",o.MEDIUM="medium",o.HIGH="high",o.URGENT="urgent",o))(y||{}),ee=(o=>(o.TODO="todo",o.IN_PROGRESS="in-progress",o.COMPLETED="completed",o.CANCELLED="cancelled",o))(ee||{});const me=(o,n)=>{const e=o.data();return{id:o.id,userId:n,...e,startDate:e.startDate?.toDate?.()||null,dueDate:e.dueDate?.toDate?.()||null,createdAt:e.createdAt?.toDate?.()||new Date,updatedAt:e.updatedAt?.toDate?.()||new Date,completedAt:e.completedAt?.toDate?.()||null}};class cr{getTasksCollection(n){return J(I,"users",n,"tasks")}async createTask(n,e){try{h("TaskService: Creating task",{userId:n,taskData:e});const s={...e,startDate:e.startDate?H.fromDate(e.startDate):null,dueDate:e.dueDate?H.fromDate(e.dueDate):null,completedAt:e.completedAt?H.fromDate(e.completedAt):null,createdAt:R(),updatedAt:R()};h("TaskService: Firestore data",s);const r=await fe(this.getTasksCollection(n),s);return h("TaskService: Task created with ID",r.id),{id:r.id,error:null}}catch(s){return{id:null,error:O(s)}}}async updateTask(n,e,s){try{h("TaskService: Updating task",{userId:n,taskId:e,updates:s});const r=X(this.getTasksCollection(n),e),a={};Object.keys(s).forEach(c=>{const d=s[c];d!==void 0&&(a[c]=d)});const i={...a,updatedAt:R()};return s.startDate!==void 0&&(i.startDate=s.startDate?H.fromDate(s.startDate):null),s.dueDate!==void 0&&(i.dueDate=s.dueDate?H.fromDate(s.dueDate):null),s.completedAt!==void 0&&(i.completedAt=s.completedAt?H.fromDate(s.completedAt):null),h("TaskService: Clean update data",i),await xe(r,i),h("TaskService: Task updated successfully"),{error:null}}catch(r){return{error:O(r)}}}async deleteTask(n,e){try{const s=X(this.getTasksCollection(n),e);return await nr(s),{error:null}}catch(s){return{error:O(s)}}}async toggleTaskCompletion(n,e,s){try{h("TaskService: Toggling task completion",{userId:n,taskId:e,isCompleted:s});const r={isCompleted:s,status:s?ee.COMPLETED:ee.TODO,completedAt:s?new Date:null};h("TaskService: Update data for toggle",r);const a=await this.updateTask(n,e,r);return a.error?Q("TaskService: Toggle completion failed",a.error):h("TaskService: Toggle completion successful"),a}catch(r){return{error:O(r)}}}subscribeToTasks(n,e){const s=A(this.getTasksCollection(n),ae("createdAt","desc"));return oe(s,r=>{h("TaskService: Received snapshot",{size:r.size,empty:r.empty,changes:r.docChanges().length});const a=r.docs.map(i=>{const c=me(i,n);return h("TaskService: Converted task",{id:c.id,title:c.title}),c});h("TaskService: Calling callback with tasks",a.length),e(a)},r=>{e([])})}subscribeToFilteredTasks(n,e,s){let r=A(this.getTasksCollection(n));return e.status&&e.status.length>0&&(r=A(r,_("status","in",e.status))),e.priority&&e.priority.length>0&&(r=A(r,_("priority","in",e.priority))),e.categoryId&&(r=A(r,_("categoryId","==",e.categoryId))),r=A(r,ae("createdAt","desc")),oe(r,a=>{const i=a.docs.map(c=>me(c,n));s(i)})}}const q=new cr,ke=pe((o,n)=>({tasks:[],loading:!1,error:null,filters:{},sort:{field:"createdAt",direction:"desc"},unsubscribe:null,setTasks:e=>o({tasks:e}),setLoading:e=>o({loading:e}),setError:e=>o({error:e}),setFilters:e=>o({filters:e}),setSort:e=>o({sort:e}),setUnsubscribe:e=>o({unsubscribe:e}),fetchTasks:()=>{const{unsubscribe:e,loading:s}=n();if(s)return;e&&e(),o({loading:!0,error:null});const a=Y.getState().user;if(!a){o({loading:!1,error:"User not authenticated"});return}const i=async(c=3)=>{try{await new Promise(g=>setTimeout(g,300)),h("TaskStore: Setting up real-time listener for tasks");const d=q.subscribeToTasks(a.uid,g=>{h("TaskStore: Received real-time tasks update",{count:g.length}),o({tasks:g,loading:!1,error:null})});o({unsubscribe:d}),h("TaskStore: Real-time listener setup complete")}catch(d){if(d.code==="permission-denied"&&c>0){setTimeout(()=>i(c-1),1e3);return}o({loading:!1,error:"Failed to load tasks. Please try refreshing the page."})}};i()},refreshTasks:()=>{n().fetchTasks()},cleanup:()=>{const{unsubscribe:e}=n();e&&(e(),o({unsubscribe:null}))},createTask:async(e,s)=>{o({loading:!0,error:null});try{const r=await q.createTask(e,s);if(h("TaskStore: Create task result",r),r.error)throw Q("TaskStore: Create task failed",r.error),o({error:r.error,loading:!1}),new Error(r.error);h("TaskStore: Task created successfully",r.id),o({loading:!1})}catch(r){throw o({error:r.message,loading:!1}),r}},updateTask:async(e,s,r)=>{try{h("TaskStore: Updating task",{userId:e,taskId:s,updates:r});const a=await q.updateTask(e,s,r);if(a.error)throw Q("TaskStore: Update task failed",a.error),o({error:a.error}),new Error(a.error);h("TaskStore: Update task successful")}catch(a){throw o({error:a.message}),a}},deleteTask:async(e,s)=>{try{const r=await q.deleteTask(e,s);if(r.error)throw o({error:r.error}),new Error(r.error)}catch(r){throw o({error:r.message}),r}},toggleTaskCompletion:async(e,s,r)=>{try{h("TaskStore: Toggling task completion",{taskId:s,isCompleted:r});const a=await q.toggleTaskCompletion(e,s,r);if(a.error)throw Q("TaskStore: Toggle completion failed",a.error),o({error:a.error}),new Error(a.error);h("TaskStore: Toggle completion successful")}catch(a){throw o({error:a.message}),a}},getFilteredTasks:()=>{const{tasks:e,filters:s,sort:r}=n();let a=[...e];if(s.status&&s.status.length>0&&(a=a.filter(i=>s.status.includes(i.status))),s.priority&&s.priority.length>0&&(a=a.filter(i=>s.priority.includes(i.priority))),s.groupId&&(a=a.filter(i=>i.groupId===s.groupId)),s.searchQuery){const i=s.searchQuery.toLowerCase();a=a.filter(c=>c.title.toLowerCase().includes(i)||c.description?.toLowerCase().includes(i))}return s.dateRange&&(a=a.filter(i=>i.dueDate?i.dueDate>=s.dateRange.start&&i.dueDate<=s.dateRange.end:!1)),a.sort((i,c)=>{let d,g;switch(r.field){case"dueDate":d=i.dueDate?.getTime()||0,g=c.dueDate?.getTime()||0;break;case"createdAt":d=i.createdAt.getTime(),g=c.createdAt.getTime();break;case"priority":const m={[y.URGENT]:4,[y.HIGH]:3,[y.MEDIUM]:2,[y.LOW]:1};d=m[i.priority],g=m[c.priority];break;case"title":d=i.title.toLowerCase(),g=c.title.toLowerCase();break;default:return 0}return r.direction==="asc"?d>g?1:-1:d<g?1:-1}),a},getTasksByStatus:e=>{const{tasks:s}=n();return s.filter(r=>r.status===e)},getOverdueTasks:()=>{const{tasks:e}=n(),s=new Date;return e.filter(r=>r.dueDate&&r.dueDate<s&&r.status!==ee.COMPLETED)}})),ve=({isOpen:o,onClose:n,title:e,children:s,className:r=""})=>{const a=v.useRef(null),i=v.useRef(null);return v.useEffect(()=>{if(!o)return;const c=a.current;if(!c)return;i.current?.focus();const d=c.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),g=d[0],m=d[d.length-1],f=x=>{x.key==="Tab"&&(x.shiftKey?document.activeElement===g&&(x.preventDefault(),m?.focus()):document.activeElement===m&&(x.preventDefault(),g?.focus()))},b=x=>{x.key==="Escape"&&n()};return document.addEventListener("keydown",f),document.addEventListener("keydown",b),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",f),document.removeEventListener("keydown",b),document.body.style.overflow="unset"}},[o,n]),o?t.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",onClick:n,children:t.jsxs("div",{ref:a,className:`relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800 ${r}`,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",onClick:c=>c.stopPropagation(),children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h3",{ref:i,id:"modal-title",className:"text-lg font-medium text-gray-900 dark:text-white",tabIndex:-1,children:e}),t.jsx("button",{onClick:n,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300","aria-label":"ƒê√≥ng modal",children:t.jsx(Je,{className:"w-6 h-6"})})]}),s]})}):null},dr=({isOpen:o,onClose:n,onConfirm:e,title:s,message:r,confirmText:a="X√°c nh·∫≠n",cancelText:i="H·ªßy",variant:c="danger",loading:d=!1})=>{const g=()=>{e(),n()},m={danger:"bg-red-600 hover:bg-red-700 text-white focus:ring-red-500",warning:"bg-yellow-600 hover:bg-yellow-700 text-white focus:ring-yellow-500",info:"bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500"},f={danger:"text-red-600",warning:"text-yellow-600",info:"text-blue-600"},b={danger:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),warning:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),info:t.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})};return t.jsxs(ve,{isOpen:o,onClose:n,title:s,children:[t.jsx("div",{className:"mb-6",children:t.jsxs("div",{className:"flex items-start space-x-3",children:[t.jsx("div",{className:`flex-shrink-0 ${f[c]}`,children:b[c]}),t.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm leading-relaxed",children:r})]})}),t.jsxs("div",{className:"flex justify-end space-x-3",children:[t.jsx("button",{onClick:n,className:"btn-secondary",disabled:d,children:i}),t.jsx("button",{onClick:g,disabled:d,className:`px-4 py-2 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed ${m[c]}`,children:d?t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),t.jsx("span",{children:"ƒêang x·ª≠ l√Ω..."})]}):a})]})]})},ur=()=>{const[o,n]=v.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}});return{confirm:(r,a,i,c="danger",d)=>{n({isOpen:!0,title:r,message:a,onConfirm:i,variant:c,confirmText:d})},ConfirmComponent:()=>t.jsx(dr,{isOpen:o.isOpen,onClose:()=>n(r=>({...r,isOpen:!1})),onConfirm:o.onConfirm,title:o.title,message:o.message,variant:o.variant,confirmText:o.confirmText})}},we=v.createContext(null),Dr=({children:o})=>{const[n,e]=v.useState([]),s=v.useCallback((a,i,c=5e3)=>{const d=`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,g={id:d,message:a,type:i,duration:c};e(m=>[...m,g]),setTimeout(()=>{e(m=>m.filter(f=>f.id!==d))},c)},[]),r=a=>{e(i=>i.filter(c=>c.id!==a))};return t.jsxs(we.Provider,{value:{showToast:s},children:[o,t.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:n.map(a=>t.jsx(gr,{toast:a,onClose:()=>r(a.id)},a.id))})]})},gr=({toast:o,onClose:n})=>{const e={success:Ze,error:ue,warning:Ye},s={success:"bg-green-50 text-green-800 border-green-200 dark:bg-green-900/20 dark:text-green-200 dark:border-green-800",error:"bg-red-50 text-red-800 border-red-200 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800",warning:"bg-yellow-50 text-yellow-800 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-200 dark:border-yellow-800"},r=e[o.type];return t.jsx("div",{className:`p-4 rounded-lg border shadow-lg max-w-sm transform transition-all duration-300 ease-in-out ${s[o.type]}`,children:t.jsxs("div",{className:"flex items-center",children:[t.jsx(r,{className:"w-5 h-5 mr-3 flex-shrink-0"}),t.jsx("p",{className:"text-sm font-medium flex-1",children:o.message}),t.jsx("button",{onClick:n,className:"ml-3 text-current hover:opacity-70 transition-opacity","aria-label":"ƒê√≥ng th√¥ng b√°o",children:t.jsx(ue,{className:"w-4 h-4"})})]})})},De=()=>{const o=v.useContext(we);if(!o)throw new Error("useToast must be used within ToastProvider");return o};function hr(o,n){const e=new Date;e.setHours(0,0,0,0);const s=new Date(n);if(s.setHours(0,0,0,0),o.isCompleted)return{task:o,displayDate:s,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:!1};if(!o.startDate){if(!o.dueDate)return{task:o,displayDate:s,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:!1};const b=new Date(o.dueDate);b.setHours(0,0,0,0);const x=b<e,j=b.getTime()===s.getTime();return{task:o,displayDate:s,isOverdue:x,isUrgent:x,urgencyLevel:x?"critical":"normal",shouldDisplay:j}}const r=new Date(o.startDate);r.setHours(0,0,0,0);const a=o.dueDate?new Date(o.dueDate):null;if(a&&a.setHours(0,0,0,0),e<r){const b=s.getTime()===r.getTime();return{task:o,displayDate:r,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:b}}if(a&&e>a){const b=s.getTime()===a.getTime();return{task:o,displayDate:a,isOverdue:!0,isUrgent:!0,urgencyLevel:"critical",shouldDisplay:b}}const i=s.getTime()===e.getTime();if(!a)return{task:o,displayDate:e,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:i};const c=Math.max(1,Math.ceil((a.getTime()-r.getTime())/(1e3*60*60*24))),d=Math.ceil((a.getTime()-e.getTime())/(1e3*60*60*24)),g=(c-d)/c;let m="normal",f=!1;return d<=1?(m="critical",f=!0):d<=3||g>=.8?(m="urgent",f=!0):g>=.6&&(m="urgent",f=!1),{task:o,displayDate:e,isOverdue:!1,isUrgent:f,urgencyLevel:m,shouldDisplay:i}}function Te(o,n){return o.map(e=>hr(e,n)).filter(e=>e.shouldDisplay)}function mr(o,n){return n==="critical"?y.URGENT:n==="urgent"&&o.priority!==y.URGENT?y.HIGH:o.priority}const pr=({isOpen:o,onClose:n,selectedDate:e,tasks:s})=>{const{getGroupById:r}=be(),{deleteTask:a}=ke(),{user:i}=Y(),{confirm:c,ConfirmComponent:d}=ur(),{showToast:g}=De(),[m,f]=v.useState(null),[b,x]=v.useState(!1);if(!e)return null;const S=Te(s,e).sort((u,N)=>{if(u.urgencyLevel!==N.urgencyLevel){const E={critical:3,urgent:2,normal:1};return E[N.urgencyLevel]-E[u.urgencyLevel]}const T={[y.URGENT]:4,[y.HIGH]:3,[y.MEDIUM]:2,[y.LOW]:1};return T[N.task.priority]-T[u.task.priority]}),Z=u=>u.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),re=u=>{switch(u){case y.URGENT:return"bg-red-500";case y.HIGH:return"bg-orange-500";case y.MEDIUM:return"bg-yellow-500";case y.LOW:return"bg-green-500";default:return"bg-gray-500"}},te=u=>{switch(u){case y.URGENT:return"Kh·∫©n c·∫•p";case y.HIGH:return"Cao";case y.MEDIUM:return"Trung b√¨nh";case y.LOW:return"Th·∫•p";default:return"Kh√¥ng x√°c ƒë·ªãnh"}},U=u=>{switch(u){case"critical":return"C·ª±c k·ª≥ kh·∫©n c·∫•p";case"urgent":return"Kh·∫©n c·∫•p";default:return""}},se=u=>{f(u)},$=u=>{i&&c("X√≥a c√¥ng vi·ªác",`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác "${u.title}"?`,async()=>{x(!0);try{await a(i.uid,u.id),g("ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng","success")}catch{g("C√≥ l·ªói x·∫£y ra khi x√≥a c√¥ng vi·ªác","error")}finally{x(!1)}},"danger","X√≥a c√¥ng vi·ªác")};return t.jsxs(t.Fragment,{children:[t.jsxs(ve,{isOpen:o&&!m,onClose:n,title:`C√¥ng vi·ªác ng√†y ${Z(e)}`,className:"max-w-2xl",children:[t.jsx("div",{className:"max-h-96 overflow-y-auto",children:S.length===0?t.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:t.jsx("p",{children:"Kh√¥ng c√≥ c√¥ng vi·ªác n√†o trong ng√†y n√†y"})}):t.jsx("div",{className:"space-y-3",children:S.map(({task:u,isOverdue:N,urgencyLevel:T})=>{const E=u.groupId?r(u.groupId):null;return t.jsx("div",{className:`p-4 rounded-lg border ${N?"border-red-300 bg-red-50 dark:border-red-600 dark:bg-red-900/20":T==="critical"?"border-red-200 bg-red-25 dark:border-red-700 dark:bg-red-900/10":T==="urgent"?"border-orange-200 bg-orange-25 dark:border-orange-700 dark:bg-orange-900/10":"border-gray-200 bg-gray-50 dark:border-gray-600 dark:bg-gray-700"}`,children:t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsxs("div",{className:"flex-1 min-w-0",children:[t.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[t.jsx("div",{className:`w-3 h-3 rounded-full ${re(u.priority)}`}),t.jsx("h3",{className:"font-medium text-gray-900 dark:text-white truncate",children:u.title}),N&&t.jsx("span",{className:"text-red-600 font-bold text-sm",title:"Qu√° h·∫°n",children:"‚ö† Qu√° h·∫°n"}),!N&&T==="critical"&&t.jsxs("span",{className:"text-red-500 font-bold text-sm",title:"C·ª±c k·ª≥ kh·∫©n c·∫•p",children:["üî• ",U(T)]}),!N&&T==="urgent"&&t.jsxs("span",{className:"text-orange-500 font-bold text-sm",title:"Kh·∫©n c·∫•p",children:["‚ö° ",U(T)]})]}),u.description&&t.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:u.description}),t.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs text-gray-500 dark:text-gray-400",children:[t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"ƒê·ªô ∆∞u ti√™n:"}),t.jsx("span",{className:"font-medium",children:te(u.priority)})]}),E&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"Nh√≥m:"}),t.jsxs("span",{className:"font-medium",children:[E.icon," ",E.name]})]}),u.startDate&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"B·∫Øt ƒë·∫ßu:"}),t.jsx("span",{className:"font-medium",children:new Date(u.startDate).toLocaleDateString("vi-VN")})]}),u.dueDate&&t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("span",{children:"H·∫°n cu·ªëi:"}),t.jsx("span",{className:"font-medium",children:new Date(u.dueDate).toLocaleDateString("vi-VN")})]})]})]}),t.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[t.jsx("button",{onClick:()=>se(u),className:"text-gray-400 hover:text-blue-600 transition-colors p-1 rounded",title:"Ch·ªânh s·ª≠a c√¥ng vi·ªác",disabled:b,children:t.jsx(_e,{className:"w-4 h-4"})}),t.jsx("button",{onClick:()=>$(u),className:"text-gray-400 hover:text-red-600 transition-colors p-1 rounded",title:"X√≥a c√¥ng vi·ªác",disabled:b,children:t.jsx(er,{className:"w-4 h-4"})})]})]})},u.id)})})}),S.length>0&&t.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-600",children:t.jsxs("div",{className:"flex justify-between text-sm text-gray-600 dark:text-gray-300",children:[t.jsxs("span",{children:["T·ªïng c·ªông: ",S.length," c√¥ng vi·ªác"]}),t.jsxs("div",{className:"flex space-x-4",children:[S.filter(u=>u.urgencyLevel==="critical"||u.isOverdue).length>0&&t.jsxs("span",{className:"text-red-600",children:["Kh·∫©n c·∫•p: ",S.filter(u=>u.urgencyLevel==="critical"||u.isOverdue).length]}),S.filter(u=>u.urgencyLevel==="urgent"&&!u.isOverdue).length>0&&t.jsxs("span",{className:"text-orange-600",children:["C·∫ßn ch√∫ √Ω: ",S.filter(u=>u.urgencyLevel==="urgent"&&!u.isOverdue).length]})]})]})}),t.jsx(d,{})]}),m&&t.jsx(ye,{task:m,onClose:()=>f(null),onSuccess:()=>{f(null),g("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng","success")}})]})},Tr=({tasks:o})=>{const[n,e]=v.useState(new Date),[s,r]=v.useState(null),[a,i]=v.useState(null),[c,d]=v.useState(null),[g,m]=v.useState(null),[f,b]=v.useState(null),[x,j]=v.useState(null),[S,Z]=v.useState(!1),[re,te]=v.useState(null),{user:U}=Y(),{getGroupById:se}=be(),{filters:$,toggleTaskCompletion:u,updateTask:N}=ke(),{showToast:T}=De(),E=$.groupId?o.filter(l=>l.groupId===$.groupId):o,G=n.getFullYear(),M=n.getMonth(),je=new Date,Ne=new Date(G,M,1),Ce=new Date(G,M+1,0).getDate(),Se=Ne.getDay(),Ee=new Date(G,M-1,0),Ge=Se,B=[];for(let l=Ge;l>0;l--){const p=Ee.getDate()-l+1,D=new Date(G,M-1,p);B.push({date:D,day:p,isCurrentMonth:!1,isToday:!1})}for(let l=1;l<=Ce;l++){const p=new Date(G,M,l),D=p.toDateString()===je.toDateString();B.push({date:p,day:l,isCurrentMonth:!0,isToday:D})}const Me=42-B.length;for(let l=1;l<=Me;l++){const p=new Date(G,M+1,l);B.push({date:p,day:l,isCurrentMonth:!1,isToday:!1})}const Le=l=>Te(E,l),Re=()=>{e(new Date(G,M-1,1))},Oe=()=>{e(new Date(G,M+1,1))},Ae=()=>{e(new Date)},ne=l=>{te(l),Z(!0)},Ue=(l,p)=>{l.preventDefault(),l.stopPropagation(),!p.isCompleted&&i({x:l.clientX,y:l.clientY,task:p})},ie=async l=>{if(U)try{await u(U.uid,l.id,!0),i(null),T(`ƒê√£ ho√†n th√†nh c√¥ng vi·ªác "${l.title}"`,"success")}catch(p){console.error("Failed to mark task as done:",p),T("C√≥ l·ªói x·∫£y ra khi ƒë√°nh d·∫•u ho√†n th√†nh","error")}},le=()=>{i(null),b(null)},Fe=(l,p)=>{if(p.isCompleted){l.preventDefault();return}d(p),l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("text/plain",p.id)},Ie=(l,p)=>{l.preventDefault(),l.dataTransfer.dropEffect="move",m(p)},$e=()=>{m(null)},He=async(l,p)=>{if(l.preventDefault(),m(null),!c||!U)return;const D=new Date(p);D.setHours(23,59,59,999);try{await N(U.uid,c.id,{dueDate:D}),d(null)}catch(W){console.error("Failed to update task due date:",W),d(null)}},Pe=()=>{d(null),m(null)},Be=(l,p)=>{if(p.isCompleted)return;const D=l.touches[0],W=setTimeout(()=>{b({task:p,x:D.clientX,y:D.clientY})},500);j(W)},We=()=>{x&&(clearTimeout(x),j(null))},ze=()=>{x&&(clearTimeout(x),j(null))};v.useEffect(()=>{if(a||f)return document.addEventListener("click",le),()=>document.removeEventListener("click",le)},[a,f]),v.useEffect(()=>()=>{x&&clearTimeout(x)},[x]);const Ke=l=>{switch(l){case y.URGENT:return"bg-red-500";case y.HIGH:return"bg-orange-500";case y.MEDIUM:return"bg-yellow-500";case y.LOW:return"bg-green-500";default:return"bg-gray-500"}},Ve=["January","February","March","April","May","June","July","August","September","October","November","December"],qe=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ce=(()=>{if($.groupId){const l=se($.groupId);return l?`${l.icon} ${l.name}`:"Unknown Group"}return null})();return t.jsxs("div",{className:"w-full",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsxs("div",{className:"flex items-center space-x-4",children:[t.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:[Ve[M]," ",G]}),ce&&t.jsxs("span",{className:"text-sm text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 px-2 py-1 rounded-full",children:["Filtered by: ",ce]}),t.jsx("button",{onClick:Ae,className:"text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Today"})]}),t.jsxs("div",{className:"flex items-center space-x-2",children:[t.jsx("button",{onClick:Re,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:t.jsx(rr,{className:"w-5 h-5"})}),t.jsx("button",{onClick:Oe,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:t.jsx(tr,{className:"w-5 h-5"})})]})]}),t.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:qe.map(l=>t.jsx("div",{className:"p-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400",children:l},l))}),t.jsx("div",{className:"grid grid-cols-7 gap-1",children:B.map((l,p)=>{const D=Le(l.date),W=g?.toDateString()===l.date.toDateString();return t.jsxs("div",{className:`min-h-[96px] p-2 border border-gray-200 dark:border-gray-700 rounded-lg transition-colors cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${l.isCurrentMonth?"bg-white dark:bg-gray-800":"bg-gray-50 dark:bg-gray-900"} ${l.isToday?"ring-2 ring-primary-500":""} ${W?"bg-primary-50 dark:bg-primary-900/20 border-primary-300 dark:border-primary-700 border-2":""}`,onDragOver:L=>Ie(L,l.date),onDragLeave:$e,onDrop:L=>He(L,l.date),onDoubleClick:()=>ne(l.date),title:"Double-click ƒë·ªÉ xem t·∫•t c·∫£ c√¥ng vi·ªác trong ng√†y",children:[t.jsx("div",{className:`text-sm font-medium mb-1 ${l.isCurrentMonth?l.isToday?"text-primary-600 dark:text-primary-400":"text-gray-900 dark:text-white":"text-gray-400 dark:text-gray-600"}`,children:l.day}),t.jsxs("div",{className:"space-y-1",children:[D.slice(0,4).map(L=>{const{task:w,isOverdue:z,urgencyLevel:F}=L,Xe=mr(w,F),Qe=()=>z?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 border border-red-300 dark:border-red-700":F==="critical"?"bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 border border-red-200 dark:border-red-800":F==="urgent"?"bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 border border-orange-200 dark:border-orange-800":"bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-200";return t.jsx("div",{draggable:!w.isCompleted,className:`text-xs p-1 rounded truncate transition-all duration-200 ${Qe()} cursor-move hover:opacity-80 ${c?.id===w.id?"opacity-50 scale-95":""}`,title:`üìã ${w.title}
üìä Status: ${w.status.replace("-"," ")}
${w.dueDate?`üìÖ Due: ${w.dueDate.toLocaleDateString("vi-VN")}`:"üìÖ Due: Not set"}
${w.startDate?`üöÄ Start: ${w.startDate.toLocaleDateString("vi-VN")}`:"üöÄ Start: Not set"}
${z?"‚ö†Ô∏è OVERDUE":F==="critical"?"üî• CRITICAL":F==="urgent"?"‚ö° URGENT":""}`,onDragStart:k=>{k.stopPropagation(),Fe(k,w)},onDragEnd:k=>{k.stopPropagation(),Pe()},onDoubleClick:k=>{k.stopPropagation(),r(w)},onContextMenu:k=>{k.stopPropagation(),Ue(k,w)},onTouchStart:k=>{k.stopPropagation(),Be(k,w)},onTouchEnd:k=>{k.stopPropagation(),We()},onTouchMove:k=>{k.stopPropagation(),ze()},children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center space-x-1 flex-1 min-w-0",children:[t.jsx("div",{className:`w-2 h-2 rounded-full ${Ke(Xe)}`}),t.jsx("span",{className:"truncate",children:w.title}),z&&t.jsx("span",{className:"text-red-600 font-bold",title:"Overdue",children:"‚ö†"}),!z&&F==="critical"&&t.jsx("span",{className:"text-red-500 font-bold",title:"Critical urgency",children:"üî•"}),!z&&F==="urgent"&&t.jsx("span",{className:"text-orange-500 font-bold",title:"Urgent",children:"‚ö°"})]}),t.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600 lg:hidden flex-shrink-0",onClick:k=>{k.stopPropagation();const de=k.currentTarget.getBoundingClientRect();b({task:w,x:de.right,y:de.bottom})},onDoubleClick:k=>k.stopPropagation(),"aria-label":"T√πy ch·ªçn task",children:"‚ãÆ"}),t.jsx("span",{className:"text-gray-400 text-xs hidden lg:block",children:"‚ãÆ‚ãÆ"})]})},w.id)}),D.length>4&&t.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 text-center cursor-pointer hover:text-gray-700 dark:hover:text-gray-300",onClick:L=>{L.stopPropagation(),ne(l.date)},onDoubleClick:L=>L.stopPropagation(),title:"Click ƒë·ªÉ xem t·∫•t c·∫£ c√¥ng vi·ªác",children:["+",D.length-4," more"]})]})]},p)})}),t.jsxs("div",{className:"mt-4 flex items-center justify-center space-x-4 text-xs text-gray-500 dark:text-gray-400",children:[t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),t.jsx("span",{children:"Urgent"})]}),t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-orange-500"}),t.jsx("span",{children:"High"})]}),t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),t.jsx("span",{children:"Medium"})]}),t.jsxs("div",{className:"flex items-center space-x-1",children:[t.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),t.jsx("span",{children:"Low"})]})]}),a&&t.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-1 z-50",style:{left:a.x,top:a.y},onClick:l=>l.stopPropagation(),children:[t.jsxs("button",{onClick:()=>ie(a.task),className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[t.jsx(ge,{className:"w-4 h-4 text-green-600"}),t.jsx("span",{children:"Ho√†n th√†nh"})]}),t.jsxs("button",{onClick:()=>{r(a.task),i(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),t.jsx("span",{children:"Ch·ªânh s·ª≠a"})]})]}),f&&t.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-1 z-50",style:{left:f.x,top:f.y},onClick:l=>l.stopPropagation(),children:[t.jsxs("button",{onClick:()=>{ie(f.task),b(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[t.jsx(ge,{className:"w-4 h-4 text-green-600"}),t.jsx("span",{children:"Ho√†n th√†nh"})]}),t.jsxs("button",{onClick:()=>{r(f.task),b(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),t.jsx("span",{children:"Ch·ªânh s·ª≠a"})]})]}),s&&t.jsx(ye,{task:s,onClose:()=>r(null),onSuccess:()=>r(null)}),t.jsx(pr,{isOpen:S,onClose:()=>Z(!1),selectedDate:re,tasks:E})]})};export{Tr as D,ve as M,y as P,ee as T,ke as a,ur as b,De as c,Dr as d,be as u};
