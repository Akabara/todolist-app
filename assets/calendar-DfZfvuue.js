import{r as v,j as r,F as Xe,a as Qe,b as ue,c as Je,d as Ye,e as Ze,f as _e,g as et,h as ge}from"./vendor-CvCHbQ4q.js";import{c as me}from"./state-vendor-BlHBy2Yi.js";import{d as F,f as Q,h as tt,j as M,k as pe,l as fe,q as O,w as Z,m as rt,n as at,o as se,p as oe,r as _,T as H,t as st}from"./firebase-vendor-D-WO-jOu.js";import{d as L,a as p,g as R,b as q,c as P,u as W}from"./auth-VFuffwwi.js";import{T as xe}from"./tasks-Dc86kIwL.js";const ot=(o,n)=>{const e=o.data();return{id:o.id,userId:n,...e,createdAt:e.createdAt?.toDate?.()||new Date}};class nt{getGroupsCollection(n){return F(L,"users",n,"groups")}async ensureDefaultGroup(n){try{const e=Q(L,"users",n,"groups","default");return await tt(e,{name:"Default",color:"#6B7280",icon:"üìã",createdAt:M(),updatedAt:M()},{merge:!0}),p("GroupService: Ensured default group exists"),"default"}catch(e){throw e}}async createGroup(n,e){try{p("GroupService: Creating group",{userId:n,groupData:e});const a={...e,createdAt:M(),updatedAt:M()};p("GroupService: Firestore data",a);const t=await pe(this.getGroupsCollection(n),a);return p("GroupService: Group created with ID",t.id),{id:t.id,error:null}}catch(a){return{id:null,error:R(a)}}}async updateGroup(n,e,a){try{const t=Q(this.getGroupsCollection(n),e),s={...a,updatedAt:M()};return await fe(t,s),{error:null}}catch(t){return{error:R(t)}}}async deleteGroup(n,e){if(e==="default")return{error:"Kh√¥ng th·ªÉ x√≥a nh√≥m m·∫∑c ƒë·ªãnh"};try{const a="default",t=O(F(L,"users",n,"tasks"),Z("groupId","==",e)),s=await rt(t),i=at(L);s.docs.forEach(d=>{i.update(d.ref,{groupId:a,updatedAt:M()})});const c=Q(this.getGroupsCollection(n),e);return i.delete(c),await i.commit(),p("GroupService: Group deleted and tasks moved to default",{groupId:e,tasksCount:s.size}),{error:null}}catch(a){return{error:R(a)}}}subscribeToGroups(n,e){const a=O(this.getGroupsCollection(n),se("createdAt","asc"));return oe(a,t=>{p("GroupService: Received snapshot",{size:t.size,empty:t.empty,changes:t.docChanges().length});const s=t.docs.map(i=>{const c=ot(i,n);return p("GroupService: Converted group",{id:c.id,name:c.name}),c});p("GroupService: Calling callback with groups",s.length),e(s)},t=>{e([])})}}const X=new nt;class B{static instance;authStateHistory=[];static getInstance(){return B.instance||(B.instance=new B),B.instance}async logAuthState(n){const e=q.currentUser;let a=null,t=!1;try{e&&(a=await e.getIdToken(),t=!0)}catch{}const s={timestamp:Date.now(),user:e?{uid:e.uid,email:e.email,emailVerified:e.emailVerified}:null,token:a?a.substring(0,20)+"...":null,ready:t};return this.authStateHistory.push(s),p(`üîç Auth State [${n}]:`,{timestamp:new Date().toISOString()}),s}logFirestoreOperation(n,e,a){return{operation:n,userId:e,timestamp:Date.now(),error:a?{code:a.code,message:a.message}:null}}getDebugReport(){return{authHistory:this.authStateHistory,currentAuth:{user:q.currentUser?{uid:q.currentUser.uid,email:q.currentUser.email}:null,timestamp:Date.now()}}}async waitForAuthReady(n=5e3){const e=Date.now();for(;Date.now()-e<n;){const a=q.currentUser;if(a)try{return await a.getIdToken(),p("üéâ Auth is ready!",{uid:a.uid,waitTime:Date.now()-e}),!0}catch{}await new Promise(t=>setTimeout(t,100))}return!1}}const S=B.getInstance(),ye=me((o,n)=>({groups:[],loading:!1,error:null,unsubscribe:null,isRealtimeMode:!0,setGroups:e=>o({groups:e}),setLoading:e=>o({loading:e}),setError:e=>o({error:e}),setUnsubscribe:e=>o({unsubscribe:e}),setRealtimeMode:e=>o({isRealtimeMode:e}),fetchGroups:()=>{const{unsubscribe:e,loading:a}=n();if(a)return;e&&e(),o({loading:!0,error:null});const s=W.getState().user;if(!s){o({loading:!1,error:"User not authenticated"});return}const i=async(c=3)=>{try{if(await S.logAuthState(`GroupStore-fetchGroups-attempt-${4-c}`),!await S.waitForAuthReady(2e3))throw new Error("Auth timeout - user not ready");S.logFirestoreOperation("ensureDefaultGroup-start",s.uid),await X.ensureDefaultGroup(s.uid),S.logFirestoreOperation("ensureDefaultGroup-success",s.uid),S.logFirestoreOperation("subscribeToGroups-start",s.uid);try{const g=X.subscribeToGroups(s.uid,m=>{S.logFirestoreOperation("subscribeToGroups-callback",s.uid),o({groups:m,loading:!1,error:null})});o({unsubscribe:g,isRealtimeMode:!0}),S.logFirestoreOperation("subscribeToGroups-success",s.uid)}catch(g){S.logFirestoreOperation("subscribeToGroups-fallback",s.uid,g);try{const m=F(L,"users",s.uid,"groups"),h=(await _(m)).docs.map(y=>{const N=y.data();return{id:y.id,userId:s.uid,name:N.name,color:N.color,icon:N.icon,createdAt:N.createdAt?.toDate?.()||new Date}});o({groups:h,loading:!1,error:null,isRealtimeMode:!1}),S.logFirestoreOperation("getGroups-fallback-success",s.uid)}catch(m){S.logFirestoreOperation("getGroups-fallback-error",s.uid,m),o({loading:!1,error:"Failed to load groups",isRealtimeMode:!1})}}}catch(d){if(S.logFirestoreOperation("fetchGroups-error",s.uid,d),d.code==="permission-denied"&&c>0){setTimeout(()=>i(c-1),1e3);return}o({loading:!1,error:"Failed to load groups. Please try refreshing the page."})}};i()},refreshGroups:()=>{const a=W.getState().user;if(!a)return;o({loading:!0}),(async()=>{try{const s=F(L,"users",a.uid,"groups"),c=(await _(s)).docs.map(d=>{const g=d.data();return{id:d.id,userId:a.uid,name:g.name,color:g.color,icon:g.icon,createdAt:g.createdAt?.toDate?.()||new Date}});o({groups:c,loading:!1,error:null})}catch{o({loading:!1,error:"Failed to refresh groups"})}})()},createGroup:async(e,a)=>{o({loading:!0,error:null});try{const t=await X.createGroup(e,a);if(p("GroupStore: Create group result",t),t.error)throw P("GroupStore: Create group failed",t.error),o({error:t.error,loading:!1}),new Error(t.error);p("GroupStore: Group created successfully",t.id),o({loading:!1})}catch(t){throw o({error:t.message,loading:!1}),t}},updateGroup:async(e,a,t)=>{try{const s=await X.updateGroup(e,a,t);s.error&&o({error:s.error})}catch(s){const i=R(s);o({error:i})}},deleteGroup:async(e,a)=>{try{const t=await X.deleteGroup(e,a);if(t.error)throw o({error:t.error}),new Error(t.error)}catch(t){const s=R(t);throw o({error:s}),t}},getGroupById:e=>{const{groups:a}=n();return a.find(t=>t.id===e)},getDefaultGroup:()=>{const{groups:e}=n();return e.find(a=>a.name==="Default"||a.name==="Nh√≥m m·∫∑c ƒë·ªãnh")||{id:"default",name:"Default",color:"#6B7280",icon:"üìã",userId:"",createdAt:new Date}}}));var b=(o=>(o.LOW="low",o.MEDIUM="medium",o.HIGH="high",o.URGENT="urgent",o))(b||{}),ee=(o=>(o.TODO="todo",o.IN_PROGRESS="in-progress",o.COMPLETED="completed",o.CANCELLED="cancelled",o))(ee||{});const he=(o,n)=>{const e=o.data();return{id:o.id,userId:n,...e,startDate:e.startDate?.toDate?.()||null,dueDate:e.dueDate?.toDate?.()||null,createdAt:e.createdAt?.toDate?.()||new Date,updatedAt:e.updatedAt?.toDate?.()||new Date,completedAt:e.completedAt?.toDate?.()||null}};class it{getTasksCollection(n){return F(L,"users",n,"tasks")}async createTask(n,e){try{p("TaskService: Creating task",{userId:n,taskData:e});const a={...e,startDate:e.startDate?H.fromDate(e.startDate):null,dueDate:e.dueDate?H.fromDate(e.dueDate):null,completedAt:e.completedAt?H.fromDate(e.completedAt):null,createdAt:M(),updatedAt:M()};p("TaskService: Firestore data",a);const t=await pe(this.getTasksCollection(n),a);return p("TaskService: Task created with ID",t.id),{id:t.id,error:null}}catch(a){return{id:null,error:R(a)}}}async updateTask(n,e,a){try{p("TaskService: Updating task",{userId:n,taskId:e,updates:a});const t=Q(this.getTasksCollection(n),e),s={};Object.keys(a).forEach(c=>{const d=a[c];d!==void 0&&(s[c]=d)});const i={...s,updatedAt:M()};return a.startDate!==void 0&&(i.startDate=a.startDate?H.fromDate(a.startDate):null),a.dueDate!==void 0&&(i.dueDate=a.dueDate?H.fromDate(a.dueDate):null),a.completedAt!==void 0&&(i.completedAt=a.completedAt?H.fromDate(a.completedAt):null),p("TaskService: Clean update data",i),await fe(t,i),p("TaskService: Task updated successfully"),{error:null}}catch(t){return{error:R(t)}}}async deleteTask(n,e){try{const a=Q(this.getTasksCollection(n),e);return await st(a),{error:null}}catch(a){return{error:R(a)}}}async toggleTaskCompletion(n,e,a){try{p("TaskService: Toggling task completion",{userId:n,taskId:e,isCompleted:a});const t={isCompleted:a,status:a?ee.COMPLETED:ee.TODO,completedAt:a?new Date:null};p("TaskService: Update data for toggle",t);const s=await this.updateTask(n,e,t);return s.error?P("TaskService: Toggle completion failed",s.error):p("TaskService: Toggle completion successful"),s}catch(t){return{error:R(t)}}}subscribeToTasks(n,e){const a=O(this.getTasksCollection(n),se("createdAt","desc"));return oe(a,t=>{p("TaskService: Received snapshot",{size:t.size,empty:t.empty,changes:t.docChanges().length});const s=t.docs.map(i=>{const c=he(i,n);return p("TaskService: Converted task",{id:c.id,title:c.title}),c});p("TaskService: Calling callback with tasks",s.length),e(s)},t=>{e([])})}subscribeToFilteredTasks(n,e,a){let t=O(this.getTasksCollection(n));return e.status&&e.status.length>0&&(t=O(t,Z("status","in",e.status))),e.priority&&e.priority.length>0&&(t=O(t,Z("priority","in",e.priority))),e.categoryId&&(t=O(t,Z("categoryId","==",e.categoryId))),t=O(t,se("createdAt","desc")),oe(t,s=>{const i=s.docs.map(c=>he(c,n));a(i)})}}const Y=new it,be=me((o,n)=>({tasks:[],loading:!1,error:null,filters:{},sort:{field:"createdAt",direction:"desc"},unsubscribe:null,setTasks:e=>o({tasks:e}),setLoading:e=>o({loading:e}),setError:e=>o({error:e}),setFilters:e=>o({filters:e}),setSort:e=>o({sort:e}),setUnsubscribe:e=>o({unsubscribe:e}),fetchTasks:()=>{const{unsubscribe:e,loading:a}=n();if(a)return;e&&e(),o({loading:!0,error:null});const s=W.getState().user;if(!s){o({loading:!1,error:"User not authenticated"});return}const i=async(c=3)=>{try{await new Promise(d=>setTimeout(d,300)),p("TaskStore: Using server read to avoid permission issues");try{const d=F(L,"users",s.uid,"tasks"),m=(await _(d)).docs.map(f=>{const h=f.data();return{id:f.id,userId:s.uid,title:h.title,description:h.description||"",priority:h.priority,status:h.status,isCompleted:h.isCompleted,groupId:h.groupId||"default",startDate:h.startDate?.toDate?.()||null,dueDate:h.dueDate?.toDate?.()||null,createdAt:h.createdAt?.toDate?.()||new Date,updatedAt:h.updatedAt?.toDate?.()||new Date,completedAt:h.completedAt?.toDate?.()||null}});o({tasks:m,loading:!1,error:null})}catch(d){P("TaskStore: Server read failed",d),o({loading:!1,error:"Failed to load tasks"})}}catch(d){if(d.code==="permission-denied"&&c>0){setTimeout(()=>i(c-1),500);return}o({loading:!1,error:"Failed to load tasks. Please try refreshing the page."})}};i()},refreshTasks:()=>{const a=W.getState().user;if(!a)return;o({loading:!0}),(async()=>{try{const s=F(L,"users",a.uid,"tasks"),c=(await _(s)).docs.map(d=>{const g=d.data();return{id:d.id,userId:a.uid,title:g.title,description:g.description||"",priority:g.priority,status:g.status,isCompleted:g.isCompleted,groupId:g.groupId||"default",startDate:g.startDate?.toDate?.()||null,dueDate:g.dueDate?.toDate?.()||null,createdAt:g.createdAt?.toDate?.()||new Date,updatedAt:g.updatedAt?.toDate?.()||new Date,completedAt:g.completedAt?.toDate?.()||null}});o({tasks:c,loading:!1,error:null})}catch{o({loading:!1,error:"Failed to refresh tasks"})}})()},createTask:async(e,a)=>{o({loading:!0,error:null});try{const t=await Y.createTask(e,a);if(p("TaskStore: Create task result",t),t.error)throw P("TaskStore: Create task failed",t.error),o({error:t.error,loading:!1}),new Error(t.error);p("TaskStore: Task created successfully",t.id),o({loading:!1})}catch(t){throw o({error:t.message,loading:!1}),t}},updateTask:async(e,a,t)=>{try{p("TaskStore: Updating task",{userId:e,taskId:a,updates:t});const s=await Y.updateTask(e,a,t);if(s.error)throw P("TaskStore: Update task failed",s.error),o({error:s.error}),new Error(s.error);p("TaskStore: Update task successful")}catch(s){throw o({error:s.message}),s}},deleteTask:async(e,a)=>{try{const t=await Y.deleteTask(e,a);if(t.error)throw o({error:t.error}),new Error(t.error)}catch(t){throw o({error:t.message}),t}},toggleTaskCompletion:async(e,a,t)=>{try{p("TaskStore: Toggling task completion",{taskId:a,isCompleted:t});const s=await Y.toggleTaskCompletion(e,a,t);if(s.error)throw P("TaskStore: Toggle completion failed",s.error),o({error:s.error}),new Error(s.error);p("TaskStore: Toggle completion successful")}catch(s){throw o({error:s.message}),s}},getFilteredTasks:()=>{const{tasks:e,filters:a,sort:t}=n();let s=[...e];if(a.status&&a.status.length>0&&(s=s.filter(i=>a.status.includes(i.status))),a.priority&&a.priority.length>0&&(s=s.filter(i=>a.priority.includes(i.priority))),a.groupId&&(s=s.filter(i=>i.groupId===a.groupId)),a.searchQuery){const i=a.searchQuery.toLowerCase();s=s.filter(c=>c.title.toLowerCase().includes(i)||c.description?.toLowerCase().includes(i))}return a.dateRange&&(s=s.filter(i=>i.dueDate?i.dueDate>=a.dateRange.start&&i.dueDate<=a.dateRange.end:!1)),s.sort((i,c)=>{let d,g;switch(t.field){case"dueDate":d=i.dueDate?.getTime()||0,g=c.dueDate?.getTime()||0;break;case"createdAt":d=i.createdAt.getTime(),g=c.createdAt.getTime();break;case"priority":const m={[b.URGENT]:4,[b.HIGH]:3,[b.MEDIUM]:2,[b.LOW]:1};d=m[i.priority],g=m[c.priority];break;case"title":d=i.title.toLowerCase(),g=c.title.toLowerCase();break;default:return 0}return t.direction==="asc"?d>g?1:-1:d<g?1:-1}),s},getTasksByStatus:e=>{const{tasks:a}=n();return a.filter(t=>t.status===e)},getOverdueTasks:()=>{const{tasks:e}=n(),a=new Date;return e.filter(t=>t.dueDate&&t.dueDate<a&&t.status!==ee.COMPLETED)}})),ke=({isOpen:o,onClose:n,title:e,children:a,className:t=""})=>{const s=v.useRef(null),i=v.useRef(null);return v.useEffect(()=>{if(!o)return;const c=s.current;if(!c)return;i.current?.focus();const d=c.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),g=d[0],m=d[d.length-1],f=y=>{y.key==="Tab"&&(y.shiftKey?document.activeElement===g&&(y.preventDefault(),m?.focus()):document.activeElement===m&&(y.preventDefault(),g?.focus()))},h=y=>{y.key==="Escape"&&n()};return document.addEventListener("keydown",f),document.addEventListener("keydown",h),document.body.style.overflow="hidden",()=>{document.removeEventListener("keydown",f),document.removeEventListener("keydown",h),document.body.style.overflow="unset"}},[o,n]),o?r.jsx("div",{className:"fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50",onClick:n,children:r.jsxs("div",{ref:s,className:`relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white dark:bg-gray-800 ${t}`,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",onClick:c=>c.stopPropagation(),children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsx("h3",{ref:i,id:"modal-title",className:"text-lg font-medium text-gray-900 dark:text-white",tabIndex:-1,children:e}),r.jsx("button",{onClick:n,className:"text-gray-400 hover:text-gray-600 dark:hover:text-gray-300","aria-label":"ƒê√≥ng modal",children:r.jsx(Xe,{className:"w-6 h-6"})})]}),a]})}):null},lt=({isOpen:o,onClose:n,onConfirm:e,title:a,message:t,confirmText:s="X√°c nh·∫≠n",cancelText:i="H·ªßy",variant:c="danger",loading:d=!1})=>{const g=()=>{e(),n()},m={danger:"bg-red-600 hover:bg-red-700 text-white focus:ring-red-500",warning:"bg-yellow-600 hover:bg-yellow-700 text-white focus:ring-yellow-500",info:"bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500"},f={danger:"text-red-600",warning:"text-yellow-600",info:"text-blue-600"},h={danger:r.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),warning:r.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"})}),info:r.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})};return r.jsxs(ke,{isOpen:o,onClose:n,title:a,children:[r.jsx("div",{className:"mb-6",children:r.jsxs("div",{className:"flex items-start space-x-3",children:[r.jsx("div",{className:`flex-shrink-0 ${f[c]}`,children:h[c]}),r.jsx("p",{className:"text-gray-600 dark:text-gray-300 text-sm leading-relaxed",children:t})]})}),r.jsxs("div",{className:"flex justify-end space-x-3",children:[r.jsx("button",{onClick:n,className:"btn-secondary",disabled:d,children:i}),r.jsx("button",{onClick:g,disabled:d,className:`px-4 py-2 rounded-lg font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed ${m[c]}`,children:d?r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),r.jsx("span",{children:"ƒêang x·ª≠ l√Ω..."})]}):s})]})]})},ct=()=>{const[o,n]=v.useState({isOpen:!1,title:"",message:"",onConfirm:()=>{}});return{confirm:(t,s,i,c="danger",d)=>{n({isOpen:!0,title:t,message:s,onConfirm:i,variant:c,confirmText:d})},ConfirmComponent:()=>r.jsx(lt,{isOpen:o.isOpen,onClose:()=>n(t=>({...t,isOpen:!1})),onConfirm:o.onConfirm,title:o.title,message:o.message,variant:o.variant,confirmText:o.confirmText})}},ve=v.createContext(null),wt=({children:o})=>{const[n,e]=v.useState([]),a=v.useCallback((s,i,c=5e3)=>{const d=Date.now().toString(),g={id:d,message:s,type:i,duration:c};e(m=>[...m,g]),setTimeout(()=>{e(m=>m.filter(f=>f.id!==d))},c)},[]),t=s=>{e(i=>i.filter(c=>c.id!==s))};return r.jsxs(ve.Provider,{value:{showToast:a},children:[o,r.jsx("div",{className:"fixed top-4 right-4 z-50 space-y-2",children:n.map(s=>r.jsx(dt,{toast:s,onClose:()=>t(s.id)},s.id))})]})},dt=({toast:o,onClose:n})=>{const e={success:Je,error:ue,warning:Qe},a={success:"bg-green-50 text-green-800 border-green-200 dark:bg-green-900/20 dark:text-green-200 dark:border-green-800",error:"bg-red-50 text-red-800 border-red-200 dark:bg-red-900/20 dark:text-red-200 dark:border-red-800",warning:"bg-yellow-50 text-yellow-800 border-yellow-200 dark:bg-yellow-900/20 dark:text-yellow-200 dark:border-yellow-800"},t=e[o.type];return r.jsx("div",{className:`p-4 rounded-lg border shadow-lg max-w-sm transform transition-all duration-300 ease-in-out ${a[o.type]}`,children:r.jsxs("div",{className:"flex items-center",children:[r.jsx(t,{className:"w-5 h-5 mr-3 flex-shrink-0"}),r.jsx("p",{className:"text-sm font-medium flex-1",children:o.message}),r.jsx("button",{onClick:n,className:"ml-3 text-current hover:opacity-70 transition-opacity","aria-label":"ƒê√≥ng th√¥ng b√°o",children:r.jsx(ue,{className:"w-4 h-4"})})]})})},ut=()=>{const o=v.useContext(ve);if(!o)throw new Error("useToast must be used within ToastProvider");return o};function gt(o,n){const e=new Date;e.setHours(0,0,0,0);const a=new Date(n);if(a.setHours(0,0,0,0),o.isCompleted)return{task:o,displayDate:a,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:!1};if(!o.startDate){if(!o.dueDate)return{task:o,displayDate:a,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:!1};const h=new Date(o.dueDate);h.setHours(0,0,0,0);const y=h<e,N=h.getTime()===a.getTime();return{task:o,displayDate:a,isOverdue:y,isUrgent:y,urgencyLevel:y?"critical":"normal",shouldDisplay:N}}const t=new Date(o.startDate);t.setHours(0,0,0,0);const s=o.dueDate?new Date(o.dueDate):null;if(s&&s.setHours(0,0,0,0),e<t){const h=a.getTime()===t.getTime();return{task:o,displayDate:t,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:h}}if(s&&e>s){const h=a.getTime()===s.getTime();return{task:o,displayDate:s,isOverdue:!0,isUrgent:!0,urgencyLevel:"critical",shouldDisplay:h}}const i=a.getTime()===e.getTime();if(!s)return{task:o,displayDate:e,isOverdue:!1,isUrgent:!1,urgencyLevel:"normal",shouldDisplay:i};const c=Math.max(1,Math.ceil((s.getTime()-t.getTime())/(1e3*60*60*24))),d=Math.ceil((s.getTime()-e.getTime())/(1e3*60*60*24)),g=(c-d)/c;let m="normal",f=!1;return d<=1?(m="critical",f=!0):d<=3||g>=.8?(m="urgent",f=!0):g>=.6&&(m="urgent",f=!1),{task:o,displayDate:e,isOverdue:!1,isUrgent:f,urgencyLevel:m,shouldDisplay:i}}function we(o,n){return o.map(e=>gt(e,n)).filter(e=>e.shouldDisplay)}function ht(o,n){return n==="critical"?b.URGENT:n==="urgent"&&o.priority!==b.URGENT?b.HIGH:o.priority}const mt=({isOpen:o,onClose:n,selectedDate:e,tasks:a})=>{const{getGroupById:t}=ye(),{deleteTask:s}=be(),{user:i}=W(),{confirm:c,ConfirmComponent:d}=ct(),{showToast:g}=ut(),[m,f]=v.useState(null),[h,y]=v.useState(!1);if(!e)return null;const E=we(a,e).sort((u,C)=>{if(u.urgencyLevel!==C.urgencyLevel){const w={critical:3,urgent:2,normal:1};return w[C.urgencyLevel]-w[u.urgencyLevel]}const j={[b.URGENT]:4,[b.HIGH]:3,[b.MEDIUM]:2,[b.LOW]:1};return j[C.task.priority]-j[u.task.priority]}),J=u=>u.toLocaleDateString("vi-VN",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),te=u=>{switch(u){case b.URGENT:return"bg-red-500";case b.HIGH:return"bg-orange-500";case b.MEDIUM:return"bg-yellow-500";case b.LOW:return"bg-green-500";default:return"bg-gray-500"}},re=u=>{switch(u){case b.URGENT:return"Kh·∫©n c·∫•p";case b.HIGH:return"Cao";case b.MEDIUM:return"Trung b√¨nh";case b.LOW:return"Th·∫•p";default:return"Kh√¥ng x√°c ƒë·ªãnh"}},I=u=>{switch(u){case"critical":return"C·ª±c k·ª≥ kh·∫©n c·∫•p";case"urgent":return"Kh·∫©n c·∫•p";default:return""}},ae=u=>{f(u)},$=u=>{i&&c("X√≥a c√¥ng vi·ªác",`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác "${u.title}"?`,async()=>{y(!0);try{await s(i.uid,u.id),g("ƒê√£ x√≥a c√¥ng vi·ªác th√†nh c√¥ng","success")}catch{g("C√≥ l·ªói x·∫£y ra khi x√≥a c√¥ng vi·ªác","error")}finally{y(!1)}},"danger","X√≥a c√¥ng vi·ªác")};return r.jsxs(r.Fragment,{children:[r.jsxs(ke,{isOpen:o&&!m,onClose:n,title:`C√¥ng vi·ªác ng√†y ${J(e)}`,className:"max-w-2xl",children:[r.jsx("div",{className:"max-h-96 overflow-y-auto",children:E.length===0?r.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:r.jsx("p",{children:"Kh√¥ng c√≥ c√¥ng vi·ªác n√†o trong ng√†y n√†y"})}):r.jsx("div",{className:"space-y-3",children:E.map(({task:u,isOverdue:C,urgencyLevel:j})=>{const w=u.groupId?t(u.groupId):null;return r.jsx("div",{className:`p-4 rounded-lg border ${C?"border-red-300 bg-red-50 dark:border-red-600 dark:bg-red-900/20":j==="critical"?"border-red-200 bg-red-25 dark:border-red-700 dark:bg-red-900/10":j==="urgent"?"border-orange-200 bg-orange-25 dark:border-orange-700 dark:bg-orange-900/10":"border-gray-200 bg-gray-50 dark:border-gray-600 dark:bg-gray-700"}`,children:r.jsxs("div",{className:"flex items-start justify-between",children:[r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[r.jsx("div",{className:`w-3 h-3 rounded-full ${te(u.priority)}`}),r.jsx("h3",{className:"font-medium text-gray-900 dark:text-white truncate",children:u.title}),C&&r.jsx("span",{className:"text-red-600 font-bold text-sm",title:"Qu√° h·∫°n",children:"‚ö† Qu√° h·∫°n"}),!C&&j==="critical"&&r.jsxs("span",{className:"text-red-500 font-bold text-sm",title:"C·ª±c k·ª≥ kh·∫©n c·∫•p",children:["üî• ",I(j)]}),!C&&j==="urgent"&&r.jsxs("span",{className:"text-orange-500 font-bold text-sm",title:"Kh·∫©n c·∫•p",children:["‚ö° ",I(j)]})]}),u.description&&r.jsx("p",{className:"text-sm text-gray-600 dark:text-gray-300 mb-2",children:u.description}),r.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs text-gray-500 dark:text-gray-400",children:[r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("span",{children:"ƒê·ªô ∆∞u ti√™n:"}),r.jsx("span",{className:"font-medium",children:re(u.priority)})]}),w&&r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("span",{children:"Nh√≥m:"}),r.jsxs("span",{className:"font-medium",children:[w.icon," ",w.name]})]}),u.startDate&&r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("span",{children:"B·∫Øt ƒë·∫ßu:"}),r.jsx("span",{className:"font-medium",children:new Date(u.startDate).toLocaleDateString("vi-VN")})]}),u.dueDate&&r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("span",{children:"H·∫°n cu·ªëi:"}),r.jsx("span",{className:"font-medium",children:new Date(u.dueDate).toLocaleDateString("vi-VN")})]})]})]}),r.jsxs("div",{className:"flex items-center space-x-2 ml-4",children:[r.jsx("button",{onClick:()=>ae(u),className:"text-gray-400 hover:text-blue-600 transition-colors p-1 rounded",title:"Ch·ªânh s·ª≠a c√¥ng vi·ªác",disabled:h,children:r.jsx(Ye,{className:"w-4 h-4"})}),r.jsx("button",{onClick:()=>$(u),className:"text-gray-400 hover:text-red-600 transition-colors p-1 rounded",title:"X√≥a c√¥ng vi·ªác",disabled:h,children:r.jsx(Ze,{className:"w-4 h-4"})})]})]})},u.id)})})}),E.length>0&&r.jsx("div",{className:"mt-4 pt-4 border-t border-gray-200 dark:border-gray-600",children:r.jsxs("div",{className:"flex justify-between text-sm text-gray-600 dark:text-gray-300",children:[r.jsxs("span",{children:["T·ªïng c·ªông: ",E.length," c√¥ng vi·ªác"]}),r.jsxs("div",{className:"flex space-x-4",children:[E.filter(u=>u.urgencyLevel==="critical"||u.isOverdue).length>0&&r.jsxs("span",{className:"text-red-600",children:["Kh·∫©n c·∫•p: ",E.filter(u=>u.urgencyLevel==="critical"||u.isOverdue).length]}),E.filter(u=>u.urgencyLevel==="urgent"&&!u.isOverdue).length>0&&r.jsxs("span",{className:"text-orange-600",children:["C·∫ßn ch√∫ √Ω: ",E.filter(u=>u.urgencyLevel==="urgent"&&!u.isOverdue).length]})]})]})}),r.jsx(d,{})]}),m&&r.jsx(xe,{task:m,onClose:()=>f(null),onSuccess:()=>{f(null),g("C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng","success")}})]})},Dt=({tasks:o})=>{const[n,e]=v.useState(new Date),[a,t]=v.useState(null),[s,i]=v.useState(null),[c,d]=v.useState(null),[g,m]=v.useState(null),[f,h]=v.useState(null),[y,N]=v.useState(null),[E,J]=v.useState(!1),[te,re]=v.useState(null),{user:I}=W(),{getGroupById:ae}=ye(),{filters:$,toggleTaskCompletion:u,updateTask:C}=be(),j=$.groupId?o.filter(l=>l.groupId===$.groupId):o,w=n.getFullYear(),G=n.getMonth(),De=new Date,Te=new Date(w,G,1),je=new Date(w,G+1,0).getDate(),Ne=Te.getDay(),Ce=new Date(w,G-1,0),Se=Ne,z=[];for(let l=Se;l>0;l--){const x=Ce.getDate()-l+1,T=new Date(w,G-1,x);z.push({date:T,day:x,isCurrentMonth:!1,isToday:!1})}for(let l=1;l<=je;l++){const x=new Date(w,G,l),T=x.toDateString()===De.toDateString();z.push({date:x,day:l,isCurrentMonth:!0,isToday:T})}const Ee=42-z.length;for(let l=1;l<=Ee;l++){const x=new Date(w,G+1,l);z.push({date:x,day:l,isCurrentMonth:!1,isToday:!1})}const Ge=l=>we(j,l),Ae=()=>{e(new Date(w,G-1,1))},Me=()=>{e(new Date(w,G+1,1))},Le=()=>{e(new Date)},ne=l=>{re(l),J(!0)},Re=(l,x)=>{l.preventDefault(),l.stopPropagation(),!x.isCompleted&&i({x:l.clientX,y:l.clientY,task:x})},ie=async l=>{if(I)try{await u(I.uid,l.id,!0),i(null)}catch(x){console.error("Failed to mark task as done:",x)}},le=()=>{i(null),h(null)},Oe=(l,x)=>{if(x.isCompleted){l.preventDefault();return}d(x),l.dataTransfer.effectAllowed="move",l.dataTransfer.setData("text/plain",x.id)},Ie=(l,x)=>{l.preventDefault(),l.dataTransfer.dropEffect="move",m(x)},Ue=()=>{m(null)},Fe=async(l,x)=>{if(l.preventDefault(),m(null),!c||!I)return;const T=new Date(x);T.setHours(23,59,59,999);try{await C(I.uid,c.id,{dueDate:T}),d(null)}catch(K){console.error("Failed to update task due date:",K),d(null)}},$e=()=>{d(null),m(null)},He=(l,x)=>{if(x.isCompleted)return;const T=l.touches[0],K=setTimeout(()=>{h({task:x,x:T.clientX,y:T.clientY})},500);N(K)},Pe=()=>{y&&(clearTimeout(y),N(null))},Be=()=>{y&&(clearTimeout(y),N(null))};v.useEffect(()=>{if(s||f)return document.addEventListener("click",le),()=>document.removeEventListener("click",le)},[s,f]),v.useEffect(()=>()=>{y&&clearTimeout(y)},[y]);const We=l=>{switch(l){case b.URGENT:return"bg-red-500";case b.HIGH:return"bg-orange-500";case b.MEDIUM:return"bg-yellow-500";case b.LOW:return"bg-green-500";default:return"bg-gray-500"}},ze=["January","February","March","April","May","June","July","August","September","October","November","December"],Ke=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ce=(()=>{if($.groupId){const l=ae($.groupId);return l?`${l.icon} ${l.name}`:"Unknown Group"}return null})();return r.jsxs("div",{className:"w-full",children:[r.jsxs("div",{className:"flex items-center justify-between mb-4",children:[r.jsxs("div",{className:"flex items-center space-x-4",children:[r.jsxs("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:[ze[G]," ",w]}),ce&&r.jsxs("span",{className:"text-sm text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 px-2 py-1 rounded-full",children:["Filtered by: ",ce]}),r.jsx("button",{onClick:Le,className:"text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Today"})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("button",{onClick:Ae,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:r.jsx(_e,{className:"w-5 h-5"})}),r.jsx("button",{onClick:Me,className:"p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700",children:r.jsx(et,{className:"w-5 h-5"})})]})]}),r.jsx("div",{className:"grid grid-cols-7 gap-1 mb-2",children:Ke.map(l=>r.jsx("div",{className:"p-2 text-center text-xs font-medium text-gray-500 dark:text-gray-400",children:l},l))}),r.jsx("div",{className:"grid grid-cols-7 gap-1",children:z.map((l,x)=>{const T=Ge(l.date),K=g?.toDateString()===l.date.toDateString();return r.jsxs("div",{className:`min-h-[96px] p-2 border border-gray-200 dark:border-gray-700 rounded-lg transition-colors cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 ${l.isCurrentMonth?"bg-white dark:bg-gray-800":"bg-gray-50 dark:bg-gray-900"} ${l.isToday?"ring-2 ring-primary-500":""} ${K?"bg-primary-50 dark:bg-primary-900/20 border-primary-300 dark:border-primary-700 border-2":""}`,onDragOver:A=>Ie(A,l.date),onDragLeave:Ue,onDrop:A=>Fe(A,l.date),onDoubleClick:()=>ne(l.date),title:"Double-click ƒë·ªÉ xem t·∫•t c·∫£ c√¥ng vi·ªác trong ng√†y",children:[r.jsx("div",{className:`text-sm font-medium mb-1 ${l.isCurrentMonth?l.isToday?"text-primary-600 dark:text-primary-400":"text-gray-900 dark:text-white":"text-gray-400 dark:text-gray-600"}`,children:l.day}),r.jsxs("div",{className:"space-y-1",children:[T.slice(0,4).map(A=>{const{task:D,isOverdue:V,urgencyLevel:U}=A,Ve=ht(D,U),qe=()=>V?"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 border border-red-300 dark:border-red-700":U==="critical"?"bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300 border border-red-200 dark:border-red-800":U==="urgent"?"bg-orange-50 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300 border border-orange-200 dark:border-orange-800":"bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-200";return r.jsx("div",{draggable:!D.isCompleted,className:`text-xs p-1 rounded truncate transition-all duration-200 ${qe()} cursor-move hover:opacity-80 ${c?.id===D.id?"opacity-50 scale-95":""}`,title:`üìã ${D.title}
üìä Status: ${D.status.replace("-"," ")}
${D.dueDate?`üìÖ Due: ${D.dueDate.toLocaleDateString("vi-VN")}`:"üìÖ Due: Not set"}
${D.startDate?`üöÄ Start: ${D.startDate.toLocaleDateString("vi-VN")}`:"üöÄ Start: Not set"}
${V?"‚ö†Ô∏è OVERDUE":U==="critical"?"üî• CRITICAL":U==="urgent"?"‚ö° URGENT":""}`,onDragStart:k=>{k.stopPropagation(),Oe(k,D)},onDragEnd:k=>{k.stopPropagation(),$e()},onDoubleClick:k=>{k.stopPropagation(),t(D)},onContextMenu:k=>{k.stopPropagation(),Re(k,D)},onTouchStart:k=>{k.stopPropagation(),He(k,D)},onTouchEnd:k=>{k.stopPropagation(),Pe()},onTouchMove:k=>{k.stopPropagation(),Be()},children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center space-x-1 flex-1 min-w-0",children:[r.jsx("div",{className:`w-2 h-2 rounded-full ${We(Ve)}`}),r.jsx("span",{className:"truncate",children:D.title}),V&&r.jsx("span",{className:"text-red-600 font-bold",title:"Overdue",children:"‚ö†"}),!V&&U==="critical"&&r.jsx("span",{className:"text-red-500 font-bold",title:"Critical urgency",children:"üî•"}),!V&&U==="urgent"&&r.jsx("span",{className:"text-orange-500 font-bold",title:"Urgent",children:"‚ö°"})]}),r.jsx("button",{className:"ml-1 text-gray-400 hover:text-gray-600 lg:hidden flex-shrink-0",onClick:k=>{k.stopPropagation();const de=k.currentTarget.getBoundingClientRect();h({task:D,x:de.right,y:de.bottom})},onDoubleClick:k=>k.stopPropagation(),"aria-label":"T√πy ch·ªçn task",children:"‚ãÆ"}),r.jsx("span",{className:"text-gray-400 text-xs hidden lg:block",children:"‚ãÆ‚ãÆ"})]})},D.id)}),T.length>4&&r.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 text-center cursor-pointer hover:text-gray-700 dark:hover:text-gray-300",onClick:A=>{A.stopPropagation(),ne(l.date)},onDoubleClick:A=>A.stopPropagation(),title:"Click ƒë·ªÉ xem t·∫•t c·∫£ c√¥ng vi·ªác",children:["+",T.length-4," more"]})]})]},x)})}),r.jsxs("div",{className:"mt-4 flex items-center justify-center space-x-4 text-xs text-gray-500 dark:text-gray-400",children:[r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),r.jsx("span",{children:"Urgent"})]}),r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("div",{className:"w-2 h-2 rounded-full bg-orange-500"}),r.jsx("span",{children:"High"})]}),r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),r.jsx("span",{children:"Medium"})]}),r.jsxs("div",{className:"flex items-center space-x-1",children:[r.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),r.jsx("span",{children:"Low"})]})]}),s&&r.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-1 z-50",style:{left:s.x,top:s.y},onClick:l=>l.stopPropagation(),children:[r.jsxs("button",{onClick:()=>ie(s.task),className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[r.jsx(ge,{className:"w-4 h-4 text-green-600"}),r.jsx("span",{children:"Ho√†n th√†nh"})]}),r.jsxs("button",{onClick:()=>{t(s.task),i(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),r.jsx("span",{children:"Ch·ªânh s·ª≠a"})]})]}),f&&r.jsxs("div",{className:"fixed bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg py-1 z-50",style:{left:f.x,top:f.y},onClick:l=>l.stopPropagation(),children:[r.jsxs("button",{onClick:()=>{ie(f.task),h(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[r.jsx(ge,{className:"w-4 h-4 text-green-600"}),r.jsx("span",{children:"Ho√†n th√†nh"})]}),r.jsxs("button",{onClick:()=>{t(f.task),h(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center space-x-2",children:[r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"})}),r.jsx("span",{children:"Ch·ªânh s·ª≠a"})]})]}),a&&r.jsx(xe,{task:a,onClose:()=>t(null),onSuccess:()=>t(null)}),r.jsx(mt,{isOpen:E,onClose:()=>J(!1),selectedDate:te,tasks:j})]})};export{Dt as D,ke as M,b as P,ee as T,be as a,ct as b,ut as c,wt as d,ye as u};
